<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>äºšæ´²é›†å›¢ æ•°æ®åº“ï¼ˆå‰ç«¯ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- å¯†ç å¼¹çª—è„šæœ¬å¼€å§‹ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: linear-gradient(135deg, #18181c 0%, #444 100%); color: #e0e0e0; font-family: Arial, sans-serif; padding: 20px; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 12px 28px; cursor: pointer; background: #232526; border: 1px solid #333; border-radius: 12px 12px 0 0; margin-right: 5px; color: #b0b0b0; font-weight: 500; position: relative;}
        .tab.active { background: linear-gradient(90deg, #00e676 0%, #1de9b6 100%); color: #232526; border-bottom: 1px solid #232526; }
        .tab-content { display: none; padding: 28px 24px 24px 24px; border: 1px solid #333; border-top: none; border-radius: 0 0 12px 12px; background: rgba(30,32,34,0.98); }
        .tab-content.active { display: block; }
        textarea { width: 100%; min-height: 140px; border-radius: 12px; border: 1.5px solid #333; background: linear-gradient(135deg, #232526 0%, #414345 100%); color: #fff; font-size: 16px; padding: 16px; margin-bottom: 18px; }
        button { padding: 10px 22px; background: linear-gradient(90deg, #232526 0%, #414345 100%); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; }
        button:hover, button:focus { background: linear-gradient(90deg, #00e676 0%, #1de9b6 100%); color: #232526; }
        .card-group { display: flex; gap: 18px; margin: 18px 0 0 0; flex-wrap: wrap; }
        .card-poultry { background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%); color: #232526; border-radius: 10px; padding: 14px 24px; font-weight: bold; min-width: 120px; }
        .card-beast { background: linear-gradient(90deg,#fd746c 0%,#ff9068 100%); color: #232526; border-radius: 10px; padding: 14px 24px; font-weight: bold; min-width: 120px; }
        .card-bose-red { background: linear-gradient(90deg,#ff5858 0%,#f09819 100%); color: #fff; border-radius: 10px; padding: 14px 24px; font-weight: bold; min-width: 120px; }
        .card-bose-blue { background: linear-gradient(90deg,#2193b0 0%,#6dd5ed 100%); color: #fff; border-radius: 10px; padding: 14px 24px; font-weight: bold; min-width: 120px; }
        .card-bose-green { background: linear-gradient(90deg,#56ab2f 0%,#a8e063 100%); color: #232526; border-radius: 10px; padding: 14px 24px; font-weight: bold; min-width: 120px; }
        .stat-float-bar {
            background: linear-gradient(90deg, #232526 0%, #43e97b 100%);
            color: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 24px #000a;
            padding: 18px 24px 14px 24px;
            margin: 24px 0 18px 0;
            position: relative;
            z-index: 10;
            transition: box-shadow 0.2s;
        }
        .save-btn-green {
            background: linear-gradient(90deg,#00e676 0%,#1de9b6 100%) !important;
            color: #232526 !important;
            font-weight: bold;
        }
        .stat-float-bar:hover {
            box-shadow: 0 8px 32px #00e67699, 0 4px 24px #000a;
        }
        .stat-float-title {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        .user-data-list {
            margin-top: 10px;
            max-width: 340px;
            margin-left: auto;
            margin-right: auto;
        }
        .user-data-item {
            background: linear-gradient(90deg, #181c18 0%, #38f9d7 100%);
            color: #e0ffe0;
            border-radius: 6px;
            margin-bottom: 6px;
            padding: 4px 6px 2px 6px;
            box-shadow: 0 1px 4px #0003;
            position: relative;
            font-size: 13px;
            min-height: 28px;
            max-width: 260px;
            margin-left: auto;
            margin-right: auto;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            transition: box-shadow 0.15s, border 0.15s;
            border: 1.5px solid transparent;
        }
        .user-data-item.checked {
            border: 1.5px solid #00e676;
            box-shadow: 0 2px 10px #00e67633;
        }
        .user-data-checkbox {
            margin-top: 4px;
            margin-right: 6px;
            accent-color: #00e676;
            cursor: pointer;
            flex-shrink: 0;
            transform: scale(1.1);
            pointer-events: none;
        }
        .user-data-content { flex: 1; white-space: pre-wrap; font-family: inherit; }
        .user-data-title { color: #00e676; font-weight: bold; margin-bottom: 2px; font-size: 14px; }
        @media (max-width: 600px) {
            .card-group { flex-direction: column; gap: 12px; }
            .tab-content { padding: 12px 6px 12px 6px; }
            .tab { padding: 10px 10px; }
            button { width: 100%; }
            .stat-float-bar { padding: 12px 8px 10px 8px; }
            .user-data-list {
                max-width: 100vw;
                padding-left: 0;
                padding-right: 0;
            }
            .user-data-item {
                max-width: 95vw;
                min-width: 0;
                font-size: 12px;
                padding: 6px 2px 4px 2px;
            }
        }
        #userIntersectStat {
            display:none;
            margin-top:18px;
            padding:10px 6px 8px 6px;
            background:linear-gradient(90deg,#181c18 0%,#38f9d7 100%);
            border-radius:8px;
            max-width:340px;
            margin-left:auto;
            margin-right:auto;
            color:#00e676;
            font-size:14px;
        }
        #groupSaveBox {
            margin-top:18px;
            max-width:340px;
            margin-left:auto;
            margin-right:auto;
        }
        #groupSaveMsg {
            color:#00e676;
            margin-top:6px;
            font-size:13px;
        }
        #intersectStatResult {
            margin-top:18px;
            padding:10px 6px 8px 6px;
            background:linear-gradient(90deg,#181c18 0%,#38f9d7 100%);
            border-radius:8px;
            max-width:340px;
            margin-left:auto;
            margin-right:auto;
            color:#00e676;
            font-size:14px;
        }
        #unionStatResult {
            margin-top:18px;
            padding:10px 6px 8px 6px;
            background:linear-gradient(90deg,#181c18 0%,#38f9d7 100%);
            border-radius:8px;
            max-width:340px;
            margin-left:auto;
            margin-right:auto;
            color:#00e676;
            font-size:14px;
        }
        .intersection-group {
            margin-bottom: 18px;
        }
        .number-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .number-cell {
            padding: 6px 0;
            text-align: center;
            background-color: #fffae0;
            border-radius: 3px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }
        th {
            background-color: #232526;
            color: #ffd700;
        }
        #backToTopBtn {
            display:none;
            position:fixed;
            right:18px;
            bottom:28px;
            z-index:999;
            background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);
            color:#232526;
            font-weight:bold;
            border:none;
            border-radius:50%;
            width:48px;
            height:48px;
            font-size:22px;
            box-shadow:0 2px 12px #0007;
            cursor:pointer;
        }
        .group-btns { display: flex; gap: 12px; margin-bottom: 16px; }
        .group-btn {
            padding: 8px 18px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            background: #444;
            color: #bbb;
            transition: background 0.2s, color 0.2s;
        }
        .group-btn.selected {
            background: linear-gradient(90deg,#00e676 0%,#1de9b6 100%);
            color: #232526;
        }
        .group-btn:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
            border: 1px solid #444;
        }
        .param-box {
            margin-bottom: 12px;
            background: #232526;
            border-radius: 8px;
            padding: 10px 16px;
            color: #ffd700;
        }
        .param-box input[type=number] {
            width: 60px;
            border-radius: 6px;
            border: 1px solid #444;
            padding: 2px 6px;
            font-size: 15px;
        }
        .save-param-btn {
            margin-left: 12px;
            padding: 4px 16px;
            border-radius: 6px;
            background: linear-gradient(90deg,#00e676 0%,#1de9b6 100%);
            color: #232526;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }
        .progress-bar-bg {
            width: 100%;
            height: 18px;
            background: #333;
            border-radius: 8px;
            margin: 18px 0 8px 0;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg,#ff4c4c 0%,#00e676 100%);
            width: 0%;
            transition: width 0.2s, background 0.2s;
        }
        .progress-bar-percent {
            position: absolute;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            line-height: 18px;
            z-index: 2;
            pointer-events: none;
        }
        .copy-btn {
            margin-left: 8px;
            padding: 2px 10px;
            border-radius: 5px;
            background: #ffd700;
            color: #232526;
            font-size: 13px;
            border: none;
            cursor: pointer;
        }
        .copy-btn.copied {
            background: #00e676;
            color: #fff;
        }
        .group-tag {
            display: inline-block;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 2px 2px 0 0;
        }
        .group-tag-red {
            background: #ff5858;
            color: white;
        }
        .group-tag-purple {
            background: #a742f5;
            color: white;
        }
        .group-tag-green {
            background: #56ab2f;
            color: white;
        }
        .group-tag-yellow {
            background: #ffd700;
            color: #232526;
        }
        .filter-panel {
            background: #232526;
            border-radius: 10px;
            padding: 12px 18px 8px 18px;
            margin-bottom: 18px;
            box-shadow: 0 2px 12px #0005;
            display: flex;
            flex-wrap: wrap;
            gap: 18px 32px;
            align-items: center;
            justify-content: center;
        }
        .filter-panel label {
            margin-right: 8px;
            font-size: 15px;
            font-weight: bold;
            color: #ffd700;
        }
        .filter-panel .filter-group {
            margin-bottom: 6px;
        }
        .filter-panel input[type=checkbox] {
            accent-color: #00e676;
            margin-right: 2px;
            transform: scale(1.1);
        }
      .gradient-title {
            font-size: 2.2em;
            font-weight: bold;
            text-align: center;
            letter-spacing: 2px;
            background: linear-gradient(270deg, #ff2a2a, #4fc3f7, #ff2a2a);
            background-size: 200% 200%;
            color: transparent;
            background-clip: text;
            -webkit-background-clip: text;
            animation: gradientMove 3s linear infinite;
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
       @media (max-width: 600px) {
    .group-btns {
        gap: 10px 10px;
        flex-wrap: wrap;
    }
    .group-btn {
        padding: 7px 14px;
        font-size: 14px;
        min-width: 80px;
        border-radius: 7px;
    }
}
    </style>
</head>
<body>
   <h2 class="gradient-title">äºšæ´²é›†å›¢ æ•°æ®åº“ï¼ˆå‰ç«¯ç‰ˆï¼‰</h2>
  <body>

<!-- å…¨å±€ç­›é€‰é¢æ¿æŒ‰é’® -->
<div id="filterPanelWrapper" style="margin-bottom:18px;">
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <span style="font-size:17px;color:#ffd700;font-weight:bold;">ç­›é€‰æ¡ä»¶</span>
    <button id="filterPanelToggleBtn" onclick="showFilterPanel()" style="padding:2px 14px;border-radius:6px;background:#232526;color:#ffd700;font-weight:bold;font-size:14px;border:1px solid #444;">å±•å¼€</button>
  </div>
</div>
<!-- å…¨å±€ç­›é€‰é¢æ¿æµ®å±‚ -->
<div id="globalFilterPanelModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999;background:rgba(0,0,0,0.25);">
  <div style="position:absolute;top:80px;left:50%;transform:translateX(-50%);background:#232526;padding:24px 32px;border-radius:12px;min-width:340px;box-shadow:0 8px 32px #000;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:18px;color:#ffd700;font-weight:bold;">ç­›é€‰æ¡ä»¶</span>
      <button onclick="hideFilterPanel()" style="background:none;border:none;font-size:20px;color:#ffd700;cursor:pointer;">Ã—</button>
    </div>
    <div class="filter-panel" id="globalFilterPanel" style="margin-top:18px;"></div>
  </div>
</div>
<div class="tabs">
    <div class="tab active" onclick="openTab('bigdata')">å¤§æ•°æ®è§£æ</div>
    <div class="tab" onclick="openTab('userdata')">ç”¨æˆ·æ•°æ®</div>
    <div class="tab" onclick="openTab('intersectstat')">äº¤é›†ç»Ÿè®¡</div>
    <div class="tab" onclick="openTab('unionstat')">å¹¶é›†ç»Ÿè®¡</div>
    <div class="tab" onclick="openTab('smartanalysis')">æ™ºèƒ½åˆ†æ</div>
</div>
    
<!-- å¤§æ•°æ®è§£æé¡µé¢ -->
<div id="bigdata" class="tab-content active">
    <div style="font-size:1.3em;color:#ffd700;font-weight:bold;letter-spacing:2px;margin-bottom:10px;">å¤§æ•°æ®è§£æ</div>
    <textarea id="bigDataInput" rows="6" placeholder="è¯·ç²˜è´´æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼ˆæ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼‰" style="width:100%;margin-top:32px;border-radius:8px;padding:10px 12px;background:#232526;color:#fff;border:1px solid #444;"></textarea>
    <button id="resetBigDataInputBtn" style="margin-top:8px;padding:6px 18px;border-radius:8px;background:#ff4c4c;color:#fff;font-weight:bold;">é‡ç½®è¾“å…¥æ¡†</button>
    <div style="margin:8px 0 0 0;color:#ffd700;font-weight:bold;">ç”¨æˆ·æ•°ï¼š<span id="bigDataUserCount">0</span></div>
    <button id="analyzeBtn" style="margin-top:10px;padding:8px 22px;border-radius:8px;background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);color:#232526;font-weight:bold;">ç»Ÿè®¡</button>
    <div id="bigDataResult" style="margin-top:14px;"></div>
</div>
    
<!-- ç”¨æˆ·æ•°æ®é¡µé¢ -->
<div id="userdata" class="tab-content">
    <!-- æ‚¬æµ®åˆ°é¡¶éƒ¨æŒ‰é’®ï¼Œå³ä¸‹è§’ï¼Œæ¯”åˆ°åº•éƒ¨æŒ‰é’®é«˜ -->
<button id="backToTopBtn" onclick="scrollToTop()" style="
  display:none;
  position:fixed;
  right:18px;
  bottom:148px; /* æ¯”åˆ°åº•éƒ¨æŒ‰é’®é«˜60pxï¼Œé¿å…é‡å  */
  z-index:999;
  background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);
  color:#232526;
  font-weight:bold;
  border:none;
  border-radius:50%;
  width:48px;
  height:48px;
  font-size:28px;
  box-shadow:0 2px 12px #0007;
  cursor:pointer;
  align-items:center;
  justify-content:center;
">â†‘</button>
  <!-- æ‚¬æµ®åˆ°åº•éƒ¨æŒ‰é’®ï¼Œå³ä¸‹è§’ï¼Œæ‰‹æœºç«¯åŒæ ·é€‚ç”¨ -->
<button id="scrollToBottomBtn" onclick="scrollToBottom()" style="
  display:none;
  position:fixed;
  right:18px;
  bottom:88px;
  z-index:999;
  background:linear-gradient(90deg,#ffd700 0%,#ffec80 100%);
  color:#232526;
  font-weight:bold;
  border:none;
  border-radius:50%;
  width:48px;
  height:48px;
  font-size:28px;
  box-shadow:0 2px 12px #0007;
  cursor:pointer;
  align-items:center;
  justify-content:center;
">â†“</button>
 <div style="font-size:1.3em;color:#ffd700;font-weight:bold;letter-spacing:2px;margin-bottom:10px;">ç”¨æˆ·æ•°æ®</div>
    <div style="color:#ffd700;font-weight:bold;margin-bottom:8px;">
        ç”¨æˆ·æ€»æ•°ï¼š<span id="userDataTotal">0</span>
        &nbsp;&nbsp;å·²å‹¾é€‰ï¼š<span id="userDataChecked">0</span>
        &nbsp;&nbsp;
        <button id="selectAllBtn" onclick="selectAllUsers()" style="padding:4px 14px;border-radius:6px;background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);color:#232526;font-weight:bold;font-size:13px;">ä¸€é”®å…¨é€‰</button>
    </div>
    <div id="userDataPanel" class="user-data-list"></div>
    <div id="userIntersectStat"></div>
    <div id="groupSaveBox">
        <div style="color:#ffd700;font-weight:bold;margin-bottom:6px;">ä¿å­˜å‹¾é€‰åˆ°åˆ†ç»„</div>
        <select id="saveGroupSelect" style="padding:4px 10px;border-radius:6px;font-size:14px;">
            <option value="group1">1ç 4ç 8ç 12ç ç»„</option>
            <option value="group2">4ç 8ç 12ç ç»„</option>
            <option value="group3">8ç 12ç ç»„</option>
        </select>
        <button onclick="saveCheckedToGroup()" style="margin-left:10px;padding:4px 16px;border-radius:6px;background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);color:#232526;font-weight:bold;">ä¿å­˜</button>
        <button onclick="clearGroupData()" style="margin-left:10px;padding:4px 16px;border-radius:6px;background:#ff4c4c;color:#fff;font-weight:bold;">æ¸…ç©ºåˆ†ç»„æ•°æ®</button>
        <div id="groupSaveMsg"></div>
    </div>
</div>

<!-- äº¤é›†ç»Ÿè®¡é¡µé¢ï¼ˆæ³¨æ„ï¼šç°åœ¨æ˜¯ç‹¬ç«‹çš„ï¼Œä¸åœ¨ç”¨æˆ·æ•°æ®é¡µé¢é‡Œé¢ï¼ï¼‰ -->
<div id="intersectstat" class="tab-content">
    <div style="font-size:1.3em;color:#ffd700;font-weight:bold;letter-spacing:2px;margin-bottom:10px;">äº¤é›†ç»Ÿè®¡</div>
    <div>
    <div style="color:#ffd700;font-weight:bold;margin-bottom:8px;">è¯·é€‰æ‹©åˆ†ç»„è¿›è¡Œäº¤é›†ç»Ÿè®¡</div>
    <select id="intersectGroupSelect" style="padding:4px 10px;border-radius:6px;font-size:14px;">
        <option value="group1">1ç 4ç 8ç 12ç ç»„</option>
        <option value="group2">4ç 8ç 12ç ç»„</option>
        <option value="group3">8ç 12ç ç»„</option>
    </select>
    <button onclick="showIntersectStat()" style="margin-left:10px;padding:6px 18px;border-radius:8px;background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);color:#232526;font-weight:bold;">ç»Ÿè®¡äº¤é›†</button>
    <!-- ä¸‰ä¸ªç‹¬ç«‹ä¿å­˜æŒ‰é’® -->
    <button id="saveBtn_group1" onclick="saveIntersectResultToLocal('group1')" style="margin-left:10px;padding:6px 18px;border-radius:8px;background:#444;color:#fff;font-weight:bold;">ä¿å­˜1ç 4ç 8ç 12ç </button>
    <button id="saveBtn_group2" onclick="saveIntersectResultToLocal('group2')" style="margin-left:10px;padding:6px 18px;border-radius:8px;background:#444;color:#fff;font-weight:bold;">ä¿å­˜4ç 8ç 12ç </button>
    <button id="saveBtn_group3" onclick="saveIntersectResultToLocal('group3')" style="margin-left:10px;padding:6px 18px;border-radius:8px;background:#444;color:#fff;font-weight:bold;">ä¿å­˜8ç 12ç </button>
    <button onclick="clearIntersectGroupData()" style="margin-left:10px;padding:6px 18px;border-radius:8px;background:#ff4c4c;color:#fff;font-weight:bold;">æ¸…ç©ºäº¤é›†</button>
    <span id="saveIntersectMsg" style="margin-left:10px;color:#ffd700;"></span>
</div>
<div id="intersectStatResult" style="margin-top:20px;"></div>
</div>

<!-- å¹¶é›†ç»Ÿè®¡é¡µé¢ -->
<div id="unionstat" class="tab-content">
    <div style="font-size:1.3em;color:#ffd700;font-weight:bold;letter-spacing:2px;margin-bottom:10px;">å¹¶é›†ç»Ÿè®¡</div>
    <div>
        <div style="color:#ffd700;font-weight:bold;margin-bottom:8px;">è¯·é€‰æ‹©äº¤é›†ä¿å­˜çš„ç»„è¿›è¡Œå¹¶é›†åˆ†æ</div>
        <div class="group-btns" id="unionGroupBtns">
    <button class="group-btn" id="unionBtn_group1" onclick="toggleUnionGroup('group1')">1ç 4ç 8ç 12ç ç»„</button>
    <button class="group-btn" id="unionBtn_group2" onclick="toggleUnionGroup('group2')">4ç 8ç 12ç ç»„</button>
    <button class="group-btn" id="unionBtn_group3" onclick="toggleUnionGroup('group3')">8ç 12ç ç»„</button>
</div>
<!-- å‚æ•°è®¾ç½®åŒºåŸŸ -->
<div id="unionParamBox" class="param-box" style="margin-top:15px;">
    <div style="margin-bottom:10px;color:#00e676;">è¯·è®¾ç½®æ¯ç»„çš„æœ€å°/æœ€å¤§å‡ºç°æ¬¡æ•°ï¼š</div>
    <!-- ä¸Šé¢ä¸‰ç»„ -->
    <div class="param-group-container">
        <div class="param-group">
            <div>1ç 4ç 8ç 12ç ç»„ï¼š</div>
            <input type="number" id="unionParamMin_group1" placeholder="æœ€å°å€¼" min="0" max="30" style="width:80px;">
            <input type="number" id="unionParamMax_group1" placeholder="æœ€å¤§å€¼" min="1" max="30" style="width:80px;">
            <button onclick="saveUnionParam('group1')" style="margin-left:10px;">ä¿å­˜</button>
            <span id="unionParamMsg_group1" style="margin-left:10px;color:#ff4c4c;"></span>
        </div>
        <div class="param-group">
            <div>4ç 8ç 12ç ç»„ï¼š</div>
            <input type="number" id="unionParamMin_group2" placeholder="æœ€å°å€¼" min="0" max="30" style="width:80px;">
            <input type="number" id="unionParamMax_group2" placeholder="æœ€å¤§å€¼" min="1" max="30" style="width:80px;">
            <button onclick="saveUnionParam('group2')" style="margin-left:10px;">ä¿å­˜</button>
            <span id="unionParamMsg_group2" style="margin-left:10px;color:#ff4c4c;"></span>
        </div>
        <div class="param-group">
            <div>8ç 12ç ç»„ï¼š</div>
            <input type="number" id="unionParamMin_group3" placeholder="æœ€å°å€¼" min="0" max="30" style="width:80px;">
            <input type="number" id="unionParamMax_group3" placeholder="æœ€å¤§å€¼" min="1" max="30" style="width:80px;">
            <button onclick="saveUnionParam('group3')" style="margin-left:10px;">ä¿å­˜</button>
            <span id="unionParamMsg_group3" style="margin-left:10px;color:#ff4c4c;"></span>
        </div>
    </div>
</div>
<!-- æ¨ªæ’å‚æ•°è®¾ç½® -->
<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
  <span style="color:#ffd700; font-size:13px;">æ•°å­—æ€»æ¬¡æ•°èŒƒå›´ï¼š</span>
  <span style="color:#ffd700; font-size:13px;">æœ€å°å€¼ï¼š</span>
  <input id="unionParamMin" type="number" min="0" max="99" value="0" style="width:40px; font-size:13px;">
  <span style="color:#ffd700; font-size:13px;">æœ€å¤§å€¼ï¼š</span>
  <input id="unionParamMax" type="number" min="0" max="99" value="99" style="width:40px; font-size:13px;">
 <label style="color:#ffd700; font-size:13px; display:flex; align-items:center; gap:4px; margin-left:10px;">
  <input type="checkbox" id="unionUserDedupSwitch" style="vertical-align:middle;">
  å»é‡ç”¨æˆ·å
<button onclick="applyUnionParam()" style="margin-left:8px; font-size:13px; padding:2px 10px;">åº”ç”¨è®¾ç½®</button>
</div>

<style>
.param-box {
    background: #181a1b;
    padding: 18px 20px;
    border-radius: 10
.param-group {
    background: #232526;
    border-radius: 8px;
    padding: 12px 18px;
    min-width: 260px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.param-group input[type="number"] {
    margin-right: 5px;
}
</style>
<div id="unionFilterPanel"></div>
<div style="display:flex;align-items:center;gap:24px;margin-bottom:12px;">
    <div>
     <span style="font-size:12px;color:#ffd700;">4ç å·®é›†æ¬¡æ•°åŒºé—´ï¼š</span>
        <input id="diffMin_4" type="number" value="0" min="0" max="50" style="width:40px;font-size:12px;">
        -
        <input id="diffMax_4" type="number" value="50" min="0" max="50" style="width:40px;font-size:12px;">
    </div>
    <div>
        <span style="font-size:12px;color:#ffd700;">8ç å·®é›†æ¬¡æ•°åŒºé—´ï¼š</span>
        <input id="diffMin_8" type="number" value="0" min="0" max="50" style="width:40px;font-size:12px;">
        -
        <input id="diffMax_8" type="number" value="50" min="0" max="50" style="width:40px;font-size:12px;">
    </div>
    <div>
        <span style="font-size:12px;color:#ffd700;">12ç å·®é›†æ¬¡æ•°åŒºé—´ï¼š</span>
        <input id="diffMin_12" type="number" value="0" min="0" max="50" style="width:40px;font-size:12px;">
        -
        <input id="diffMax_12" type="number" value="50" min="0" max="50" style="width:40px;font-size:12px;">
    </div>
   <button onclick="applyAllDiffSetting()" style="font-size:12px;padding:2px 10px;height:28px;">åº”ç”¨è®¾ç½®</button>
</div>
<div style="display:flex;gap:16px;margin-bottom:18px;">
  <button class="stat-btn" onclick="statAllUserCode('4', 'allUser4StatResult')">ç»Ÿè®¡æ‰€æœ‰ç”¨æˆ·4ç </button>
  <button class="stat-btn" onclick="statAllUserCode('8', 'allUser8StatResult')">ç»Ÿè®¡æ‰€æœ‰ç”¨æˆ·8ç </button>
  <button class="stat-btn" onclick="statAllUserCode('12', 'allUser12StatResult')">ç»Ÿè®¡æ‰€æœ‰ç”¨æˆ·12ç </button>
</div>
<div id="allUser4StatResult" class="stat-result" style="margin-bottom:8px;"></div>
<button class="stat-btn" id="saveAllUser4StatBtn" onclick="saveAllUserStat('4')" style="display:none;margin-bottom:18px;">ä¿å­˜4ç ç»Ÿè®¡</button>
<div id="allUser8StatResult" class="stat-result" style="margin-bottom:8px;"></div>
<button class="stat-btn" id="saveAllUser8StatBtn" onclick="saveAllUserStat('8')" style="display:none;margin-bottom:18px;">ä¿å­˜8ç ç»Ÿè®¡</button>
<div id="allUser12StatResult" class="stat-result" style="margin-bottom:8px;"></div>
<button class="stat-btn" id="saveAllUser12StatBtn" onclick="saveAllUserStat('12')" style="display:none;margin-bottom:18px;">ä¿å­˜12ç ç»Ÿè®¡</button>
   
<!-- å±•ç¤ºæ¯ä¸ªç å‹æ’é™¤çš„æ•°å­— -->
<div style="display:flex; flex-direction:column; gap:18px; align-items:flex-start; margin-bottom:18px;">
    <div>
        <div style="font-size:12px;color:#ffd700;">4ç æ’é™¤æ•°å­—ï¼š</div>
        <div id="excludeNums_4" style="min-width:180px;word-break:break-all;"></div>
    </div>
    <div>
        <div style="font-size:12px;color:#ffd700;">8ç æ’é™¤æ•°å­—ï¼š</div>
        <div id="excludeNums_8" style="min-width:180px;word-break:break-all;"></div>
    </div>
    <div>
        <div style="font-size:12px;color:#ffd700;">12ç æ’é™¤æ•°å­—ï¼š</div>
        <div id="excludeNums_12" style="min-width:180px;word-break:break-all;"></div>
    </div>
</div>
<div id="diffExcludeSummary"></div>
<div id="allUser4StatResult" class="stat-result"></div>
<div id="allUser8StatResult" class="stat-result"></div>
<div id="allUser12StatResult" class="stat-result"></div>
<button id="resetAllExcludeBtn" style="
    background:#ff4c4c;
    color:#fff;
    border:none;
    border-radius:4px;
    padding:2px 12px;
    font-size:13px;
    cursor:pointer;
    font-weight:bold;
    margin-bottom:10px;
"></button>
<style>
.stat-btn {
  flex:1;
  padding:10px 0;
  border-radius:8px;
  background:#444;
  color:#ffd700;
  font-weight:bold;
  border:none;
  font-size:16px;
  cursor:pointer;
  transition:background 0.2s;
}
.stat-btn:hover { background:#222; }
.save-btn {
  flex:1;
  padding:8px 0;
  border-radius:8px;
  background:#444;
  color:#888;
  font-weight:bold;
  border:none;
  font-size:15px;
  cursor:not-allowed;
  transition:background 0.2s;
}
.save-btn.enabled {
  background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);
  color:#232526;
  cursor:pointer;
}
.clear-btn {
  width:100%;
  padding:12px 0;
  border-radius:8px;
  background:#ff4c4c;
  color:#fff;
  font-weight:bold;
  border:none;
  font-size:16px;
  cursor:pointer;
  transition:background 0.2s;
}
.stat-result {
  margin:12px 0;
  padding:12px;
  background:#232526;
  color:#ffd700;
  border-radius:8px;
  min-height:32px;
  font-size:15px;
  word-break:break-all;
}
</style>
<div style="margin-top:20px;display:flex;">
    <button id="unionAnalyzeBtn" onclick="startUnionAnalyze()" 
            style="padding:8px 22px;border-radius:8px;background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);color:#232526;font-weight:bold;">
        å¹¶é›†åˆ†æ
            </button>
            <button id="enhancedAnalyzeBtn" onclick="showEnhancedAnalysis()" 
                    style="margin-left:15px;padding:8px 22px;border-radius:8px;background:linear-gradient(135deg,#6a11cb,#2575fc);color:white;font-weight:bold;">
                é«˜çº§åˆ†æ
            </button>
        </div>
        <!-- è¿›åº¦æ¡ -->
        <div class="progress-bar-bg" id="unionProgressBar" style="margin-top:15px;display:none;">
            <div class="progress-bar-inner" id="unionProgressInner"></div>
            <span class="progress-bar-percent" id="unionProgressPercent">0%</span>
        </div>
    </div>
    <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
    <div id="unionStatResult" style="margin-top:20px;"></div>
</div>
 <!-- æ™ºèƒ½åˆ†æé¡µé¢ -->
<div id="smartanalysis" class="tab-content">
  <div style="font-size:1.3em;color:#ffd700;font-weight:bold;letter-spacing:2px;margin-bottom:10px;">æ™ºèƒ½åˆ†æ</div>
  <div style="display:flex;gap:30px;flex-wrap:wrap;">
    <div style="flex:1;min-width:220px;">
      <h3 style="font-size:1.1em;">ç»Ÿè®¡ç»“æœ</h3>
      <div id="statisticBos"></div>
      <div id="statisticShengxiao"></div>
      <div id="statisticJiaoji"></div>
      <div id="statisticBingji"></div>
    </div>
    <div style="flex:2;min-width:260px;">
      <!-- æ™ºèƒ½åˆ†æé¡µé¢ -->
<div id="smartanalysis" class="tab-content">
  <div style="font-size:1.3em;color:#ffd700;font-weight:bold;letter-spacing:2px;margin-bottom:10px;">æ™ºèƒ½åˆ†æ</div>
  <div id="allUserCodeStat"></div>
  <!-- ä½ åŸæœ‰çš„å†…å®¹... -->
</div>
      <h3 style="font-size:1.1em;">æ™ºèƒ½åˆ†æç»“æœ</h3>
      <div id="smartAnalysisResult" style="font-size:1.2em;color:#1976d2;"></div>
    </div>
  </div>
</div>   
<button id="backToTopBtn" onclick="scrollToTop()">â†‘</button>
<script>
  document.addEventListener('DOMContentLoaded', function() {
  const PASSWORD = "124311"; // è®¾ç½®ä½ çš„å¯†ç 
  const input = prompt("è¯·è¾“å…¥è®¿é—®å¯†ç ï¼š");
  if (input === PASSWORD) {
    document.body.style.display = "block";
  } else {
    document.body.innerHTML = "";
    document.body.style.display = "block";
  }
});
// å¸¸é‡å®šä¹‰
const sxList = ['é¼ ','ç‰›','è™','å…”','é¾™','è›‡','é©¬','ç¾Š','çŒ´','é¸¡','ç‹—','çŒª'];
const headList = ['0','1','2','3','4'];
const tailList = ['0','1','2','3','4','5','6','7','8','9'];
const poultryList = ['çŒª', 'ç‹—', 'é¸¡', 'ç¾Š', 'é©¬', 'ç‰›'];
const beastList = ['é¼ ', 'è›‡', 'é¾™', 'å…”', 'è™', 'çŒ´'];
const shengxiaoMap = {
    'é¼ ': [6,18,30,42],
    'ç‰›': [5,17,29,41],
    'è™': [4,16,28,40],
    'å…”': [3,15,27,39],
    'é¾™': [2,14,26,38],
    'è›‡': [1,13,25,37,49],
    'é©¬': [12,24,36,48],
    'ç¾Š': [11,23,35,47],
    'çŒ´': [10,22,34,46],
    'é¸¡': [9,21,33,45],
    'ç‹—': [8,20,32,44],
    'çŒª': [7,19,31,43]
};
const boseMap = {
    '01': 'çº¢', '02': 'çº¢', '07': 'çº¢', '08': 'çº¢', '12': 'çº¢', '13': 'çº¢', '18': 'çº¢', '19': 'çº¢', '23': 'çº¢', '24': 'çº¢', '29': 'çº¢', '30': 'çº¢', '34': 'çº¢', '35': 'çº¢', '40': 'çº¢', '45': 'çº¢', '46': 'çº¢',
    '03': 'è“', '04': 'è“', '09': 'è“', '10': 'è“', '14': 'è“', '15': 'è“', '20': 'è“', '25': 'è“', '26': 'è“', '31': 'è“', '36': 'è“', '37': 'è“', '41': 'è“', '42': 'è“', '47': 'è“', '48': 'è“',
    '05': 'ç»¿', '06': 'ç»¿', '11': 'ç»¿', '16': 'ç»¿', '17': 'ç»¿', '21': 'ç»¿', '22': 'ç»¿', '27': 'ç»¿', '28': 'ç»¿', '32': 'ç»¿', '33': 'ç»¿', '38': 'ç»¿', '39': 'ç»¿', '43': 'ç»¿', '44': 'ç»¿', '49': 'ç»¿'
};

// å…¨å±€å˜é‡
let activePage = 'bigdata';
let userRawDataList = [];
let savedGroups = { group1: [], group2: [], group3: [] };
let intersectSavedNums = { group1: [], group2: [], group3: [] };
let unionParam = { group1: {}, group2: {}, group3: {} };
let coreParam = JSON.parse(localStorage.getItem('nao_core_param') || 'null') || {
    sx: [...sxList],
    head: [...headList],
    tail: [...tailList]
};
let unionSelectedGroups = [];
let intersectStatReady = { group1: false, group2: false, group3: false };
// æ¸²æŸ“å…¨å±€ç­›é€‰é¢æ¿
function renderGlobalFilterPanel() {
    let html = '';
    html += `<div class="filter-group"><label>ç”Ÿè‚–</label>`;
    sxList.forEach(sx => {
        html += `<input type="checkbox" class="filter-sx" value="${sx}" ${coreParam.sx.includes(sx)?'checked':''}>${sx}`;
    });
    html += `</div><div class="filter-group"><label>å¤´æ•°</label>`;
    headList.forEach(h => {
        html += `<input type="checkbox" class="filter-head" value="${h}" ${coreParam.head.includes(h)?'checked':''}>${h}`;
    });
    html += `</div><div class="filter-group"><label>å°¾æ•°</label>`;
    tailList.forEach(t => {
        html += `<input type="checkbox" class="filter-tail" value="${t}" ${coreParam.tail.includes(t)?'checked':''}>${t}`;
    });
    html += `</div>`;
    document.getElementById('globalFilterPanel').innerHTML = html;
    document.querySelectorAll('.filter-sx,.filter-head,.filter-tail').forEach(el=>{
        el.onchange = updateCoreParamFromUI;
    });
}

// æ–°å¢ï¼šæ¸²æŸ“å¹¶é›†ç­›é€‰é¢æ¿
function renderUnionFilterPanel() {
    let html = '';
    html += `<div class="filter-group"><label>ç”Ÿè‚–</label>`;
    sxList.forEach(sx => {
        html += `<input type="checkbox" class="union-filter-sx" value="${sx}" ${coreParam.sx.includes(sx)?'checked':''}>${sx}`;
    });
    html += `</div><div class="filter-group"><label>å¤´æ•°</label>`;
    headList.forEach(h => {
        html += `<input type="checkbox" class="union-filter-head" value="${h}" ${coreParam.head.includes(h)?'checked':''}>${h}`;
    });
    html += `</div><div class="filter-group"><label>å°¾æ•°</label>`;
    tailList.forEach(t => {
        html += `<input type="checkbox" class="union-filter-tail" value="${t}" ${coreParam.tail.includes(t)?'checked':''}>${t}`;
    });
    html += `</div>`;
    document.getElementById('unionFilterPanel').innerHTML = html;
    
    document.querySelectorAll('.union-filter-sx, .union-filter-head, .union-filter-tail').forEach(el => {
        el.onchange = updateCoreParamFromUnionFilter;
    });
}
// ä»UIæ›´æ–°æ ¸å¿ƒå‚æ•°
function updateCoreParamFromUI() {
    let sx = Array.from(document.querySelectorAll('.filter-sx:checked')).map(x=>x.value);
    let head = Array.from(document.querySelectorAll('.filter-head:checked')).map(x=>x.value);
    let tail = Array.from(document.querySelectorAll('.filter-tail:checked')).map(x=>x.value);
    coreParam = { sx, head, tail };
    localStorage.setItem('nao_core_param', JSON.stringify(coreParam));
    analyzeBigData && analyzeBigData();
    syncUserDataPanel && syncUserDataPanel();
    if(document.getElementById('intersectStatResult')) showIntersectStat && showIntersectStat();
    if(document.getElementById('unionStatResult')) showUnionStat && showUnionStat();
    // åŒæ­¥å¹¶é›†ç­›é€‰é¢æ¿
    renderUnionFilterPanel();
    // æ–°å¢ï¼šç­›é€‰å˜åŠ¨æ—¶è‡ªåŠ¨åˆ·æ–°12ç ç»Ÿè®¡
    statAllTwelve && statAllTwelve();
}

// æ–°å¢ï¼šä»å¹¶é›†ç­›é€‰é¢æ¿æ›´æ–°æ ¸å¿ƒå‚æ•°
function updateCoreParamFromUnionFilter() {
let sx = Array.from(document.querySelectorAll('.union-filter-sx:checked')).map(x => x.value);
let head = Array.from(document.querySelectorAll('.union-filter-head:checked')).map(x => x.value);
let tail = Array.from(document.querySelectorAll('.union-filter-tail:checked')).map(x => x.value);coreParam = { sx, head, tail };
localStorage.setItem('nao_core_param', JSON.stringify(coreParam));

// å¦‚æœå½“å‰åœ¨å¹¶é›†ç»Ÿè®¡é¡µé¢ï¼Œæ¸…ç©ºç»“æœç­‰å¾…é‡æ–°è®¡ç®—
if (activePage === 'unionstat') {
    document.getElementById('unionStatResult').innerHTML = '';
}
    
    // å¦‚æœå½“å‰åœ¨å¤§æ•°æ®è§£æé¡µé¢ï¼Œé‡æ–°è®¡ç®—
    if (activePage === 'bigdata') {
        analyzeBigData();
    }
    
    // åŒæ­¥å…¨å±€ç­›é€‰é¢æ¿
    renderGlobalFilterPanel();
}

// è·å–æ ¸å¿ƒç­›é€‰æ¡ä»¶
function getCoreFilter() {
    return coreParam;
}

// æ•°æ®å­˜å‚¨ç›¸å…³å‡½æ•°
function saveGroupsToLocal() {
    try {
        localStorage.setItem('nao_saved_groups', JSON.stringify(savedGroups));
    } catch(e) {
        console.error('ä¿å­˜åˆ†ç»„æ•°æ®å¤±è´¥:', e);
    }
}

function saveIntersectNumsToLocal() {
    try {
        localStorage.setItem('nao_intersect_nums', JSON.stringify(intersectSavedNums));
    } catch(e) {
        console.error('ä¿å­˜äº¤é›†æ•°æ®å¤±è´¥:', e);
    }
}

function saveUnionParamToLocal() {
    try {
        localStorage.setItem('nao_union_param', JSON.stringify(unionParam));
    } catch(e) {
        console.error('ä¿å­˜å‚æ•°å¤±è´¥:', e);
    }
}

function loadGroupsFromLocal() {
    try {
        let data = localStorage.getItem('nao_saved_groups');
        if (data) savedGroups = JSON.parse(data);
    } catch(e) {
        console.error('è¯»å–åˆ†ç»„æ•°æ®å¤±è´¥:', e);
        savedGroups = { group1: [], group2: [], group3: [] };
    }
    try {
        let data = localStorage.getItem('nao_intersect_nums');
        if (data) {
            let obj = JSON.parse(data);
            // å…¼å®¹è€æ•°æ®
            ['group1','group2','group3'].forEach(g=>{
                if(Array.isArray(obj[g])) {
                    obj[g] = { nums: obj[g], countMap: {} };
                }
            });
            intersectSavedNums = obj;
        }
    } catch(e) {
        console.error('è¯»å–äº¤é›†æ•°æ®å¤±è´¥:', e);
        intersectSavedNums = { group1: [], group2: [], group3: [] };
    }
    try {
        let data = localStorage.getItem('nao_union_param');
        if (data) unionParam = JSON.parse(data);
    } catch(e) {
        console.error('è¯»å–å‚æ•°å¤±è´¥:', e);
        unionParam = { group1: {}, group2: {}, group3: {} };
    }
}
// é¡µé¢åˆ‡æ¢
function openTab(pageName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(pageName).classList.add('active');
    document.querySelector(`.tab[onclick="openTab('${pageName}')"]`).classList.add('active');
    activePage = pageName;
    if(pageName === 'bigdata') updateBigDataUserCount();
    if(pageName === 'userdata') {
        syncUserDataPanel();
        document.getElementById('groupSaveMsg').textContent = "";
        document.getElementById('userIntersectStat').style.display = 'none';
    }
    if(pageName === 'intersectstat') {
        document.getElementById('intersectStatResult').innerHTML = '';
        updateIntersectGroupBtns();
    }
    if(pageName === 'unionstat') {
        unionSelectedGroups = [];
        syncUnionParamInputs();
        document.getElementById('unionProgressBar').style.display = 'none';
        document.getElementById('unionStatResult').innerHTML = '';
        updateUnionGroupBtns();
        renderUnionFilterPanel(); // ç¡®ä¿ç­›é€‰æ¡ä»¶åŒæ­¥
    }
}

/// ç”¨æˆ·æ•°æ®ç›¸å…³å‡½æ•°
function syncUserDataPanel() {
let input = document.getElementById('bigDataInput') ? document.getElementById('bigDataInput').value : '';
let lines = input.split('\n');
let users = {};
let userCodes = {};
let userOrder = [];
let currentUser = null;

// æ”¯æŒæ‰€æœ‰å¸¸è§ç‰¹æ®Šç¬¦å·å’Œ emoji
const userNamePattern = '[\\u4e00-\\u9fa5A-Za-z0-9_\\-ï¼ˆï¼‰\\(\\)\\[\\]ã€ã€‘â¤ï¸â€ğŸ”¥,.ï¼Œã€‚:ï¼šã€\\s\\uD83C-\\uDBFF\\uDC00-\\uDFFF]+';
// æ”¯æŒå„ç§â€œxç â€å†™æ³•
const codeTypePattern = '(?:1|ä¸€|4|å››|8|å…«|12|åäºŒ)';

for (let i = 0; i < lines.length; i++) {
    let line = lines[i].trim();
    if (!line) continue;

    // 1. t.me é“¾æ¥åç”¨æˆ·å
    let match = line.match(/^https?:\/\/t\.me\/[^\/]+\/\d+\s*([^\[\]ï¼Œ, :ï¼š]+)[,ï¼Œ :ï¼š]?/);
    if (match) {
        currentUser = match[1].trim();
        if (!users[currentUser]) {
            users[currentUser] = [];
            userOrder.push(currentUser);
            userCodes[currentUser] = { code1: '', code4: '', code8: '', code12: '' };
        }
        users[currentUser].push(line);
        continue;
    }

    // 2. è¡Œé¦–ä¸ºâ€œç”¨æˆ·å:â€æˆ–â€œç”¨æˆ·åï¼šâ€æˆ–â€œç”¨æˆ·å,â€æˆ–â€œç”¨æˆ·å â€ï¼ˆæ”¯æŒå…¨è§’åŠè§’å’Œå„ç§ç¬¦å·ï¼‰
    let nameLine = line.match(new RegExp(`^(${userNamePattern})[,ï¼Œ:ï¼š ]{1,2}$`));
    if (nameLine) {
        currentUser = nameLine[1].trim();
        if (!users[currentUser]) {
            users[currentUser] = [];
            userOrder.push(currentUser);
            userCodes[currentUser] = { code1: '', code4: '', code8: '', code12: '' };
        }
        users[currentUser].push(line);
        continue;
    }

    // 3. å·ç è¡Œé‡Œå¸¦ç”¨æˆ·åï¼ˆå¦‚â€œé˜¿æ°: æ–°æ¾³1ç ï¼š34â€æˆ–â€œé˜¿æ°: æ–°æ¾³ä¸€ç ï¼š34â€ï¼‰
    let userCodeMatch = line.match(new RegExp(`^(${userNamePattern})[,ï¼Œ:ï¼š ]+æ–°?[æ¾³å¥¥]?(?:\\d+æœŸ)?\\s*(${codeTypePattern})ç [ï¼š: ]+([\\d\\s.,ï¼Œã€|/-]+)`));
    if (userCodeMatch) {
        currentUser = userCodeMatch[1].trim();
        let codeTypeRaw = userCodeMatch[2];
        let codeContent = userCodeMatch[3];
        if (!users[currentUser]) {
            users[currentUser] = [];
            userOrder.push(currentUser);
            userCodes[currentUser] = { code1: '', code4: '', code8: '', code12: '' };
        }
        let codeType = (
            codeTypeRaw === '1' || codeTypeRaw === 'ä¸€' ? 'code1' :
            codeTypeRaw === '4' || codeTypeRaw === 'å››' ? 'code4' :
            codeTypeRaw === '8' || codeTypeRaw === 'å…«' ? 'code8' :
            codeTypeRaw === '12' || codeTypeRaw === 'åäºŒ' ? 'code12' : ''
        );
        if (codeType) userCodes[currentUser][codeType] = codeContent;
        users[currentUser].push(line);
        continue;
    }

    // 4. å·ç è¡Œï¼ˆä¸å¸¦ç”¨æˆ·åï¼Œå½’åˆ° currentUserï¼Œæ”¯æŒå„ç§â€œxç â€å†™æ³•ï¼‰
    let codeMatch = line.match(new RegExp(`æ–°?[æ¾³å¥¥]?(?:\\d+æœŸ)?\\s*(${codeTypePattern})ç [ï¼š: ]+([\\d\\s.,ï¼Œã€|/-]+)`));
    if (codeMatch && codeMatch[1] && codeMatch[2]) {
        let codeTypeRaw = codeMatch[1];
        let codeContent = codeMatch[2];
        if (!currentUser) continue; // æ²¡æœ‰ç”¨æˆ·åå°±è·³è¿‡
        if (!users[currentUser]) {
            users[currentUser] = [];
            userOrder.push(currentUser);
            userCodes[currentUser] = { code1: '', code4: '', code8: '', code12: '' };
        }
        let codeType = (
            codeTypeRaw === '1' || codeTypeRaw === 'ä¸€' ? 'code1' :
            codeTypeRaw === '4' || codeTypeRaw === 'å››' ? 'code4' :
            codeTypeRaw === '8' || codeTypeRaw === 'å…«' ? 'code8' :
            codeTypeRaw === '12' || codeTypeRaw === 'åäºŒ' ? 'code12' : ''
        );
        if (codeType) userCodes[currentUser][codeType] = codeContent;
        users[currentUser].push(line);
        continue;
    }

    // 5. å…¼å®¹â€œ12ç  ï¼š...â€ç­‰æ ¼å¼
    let codeMatch2 = line.match(new RegExp(`(${codeTypePattern})ç \\s*[ï¼š: ]+([\\d\\s.,ï¼Œã€|/-]+)`));
    if (codeMatch2 && codeMatch2[1] && codeMatch2[2]) {
        let codeTypeRaw = codeMatch2[1];
        let codeContent = codeMatch2[2];
        if (!currentUser) continue;
        if (!users[currentUser]) {
            users[currentUser] = [];
            userOrder.push(currentUser);
            userCodes[currentUser] = { code1: '', code4: '', code8: '', code12: '' };
        }
        let codeType = (
            codeTypeRaw === '1' || codeTypeRaw === 'ä¸€' ? 'code1' :
            codeTypeRaw === '4' || codeTypeRaw === 'å››' ? 'code4' :
            codeTypeRaw === '8' || codeTypeRaw === 'å…«' ? 'code8' :
            codeTypeRaw === '12' || codeTypeRaw === 'åäºŒ' ? 'code12' : ''
        );
        if (codeType) userCodes[currentUser][codeType] = codeContent;
        users[currentUser].push(line);
        continue;
    }

    // 6. å…¶å®ƒå†…å®¹ä¹Ÿè¿½åŠ 
    if (currentUser) users[currentUser].push(line);
}
userRawDataList = [];
for (let name of userOrder) {
    userRawDataList.push({
        name,
        raw: users[name].join('\n'),
        code1: userCodes[name]?.code1 || '',
        code4: userCodes[name]?.code4 || '',
        code8: userCodes[name]?.code8 || '',
        code12: userCodes[name]?.code12 || ''
    });
}
    
    let idxToGroup = {};
    userRawDataList.forEach((u, idx) => { idxToGroup[idx]=[]; });
    Object.entries(savedGroups).forEach(([group, arr])=>{
        arr.forEach(idx=>{
            if(!idxToGroup[idx]) idxToGroup[idx]=[];
            idxToGroup[idx].push(group);
        });
    });
    let html = '';
    userRawDataList.forEach((u, idx) => {
        let groupArr = idxToGroup[idx]||[];
        let tags = '';
        if(groupArr.length === 3) {
            tags += `<span class="group-tag group-tag-yellow">å·²ä¿å­˜åˆ°å…¨éƒ¨åˆ†ç»„</span>`;
        } else {
            if(groupArr.includes('group1')) tags += `<span class="group-tag group-tag-red">å·²ä¿å­˜åˆ°1ç 4ç 8ç 12ç æ•°æ®åº“</span>`;
            if(groupArr.includes('group2')) tags += `<span class="group-tag group-tag-purple">å·²ä¿å­˜åˆ°4ç 8ç 12ç æ•°æ®åº“</span>`;
            if(groupArr.includes('group3')) tags += `<span class="group-tag group-tag-green">å·²ä¿å­˜åˆ°8ç 12ç æ•°æ®åº“</span>`;
        }
        html += `
        <div class="user-data-item" data-idx="${idx}" onclick="onUserDataItemClick(event,${idx})">
            <input type="checkbox" class="user-data-checkbox" data-idx="${idx}" onchange="onUserDataCheck(this)">
            <div class="user-data-content">
                <div class="user-data-title">${u.name}</div>
                <div>${u.raw.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                <div>${tags}</div>
            </div>
        </div>`;
    });
    document.getElementById('userDataPanel').innerHTML = html;
    document.getElementById('userDataTotal').textContent = userRawDataList.length;
    updateUserDataChecked();
    updateUserDataCheckedStyle();
}

// ç”¨æˆ·æ•°æ®æ“ä½œå‡½æ•°
function onUserDataItemClick(event, idx) {
    if (event.target.classList.contains('user-data-checkbox')) return;
    let checkbox = document.querySelector(`.user-data-checkbox[data-idx="${idx}"]`);
    checkbox.checked = !checkbox.checked;
    onUserDataCheck(checkbox);
}

function updateUserDataCheckedStyle() {
    document.querySelectorAll('.user-data-item').forEach(item => {
        let idx = item.getAttribute('data-idx');
        let checkbox = document.querySelector(`.user-data-checkbox[data-idx="${idx}"]`);
        if (checkbox.checked) {
            item.classList.add('checked');
        } else {
            item.classList.remove('checked');
        }
    });
}

function onUserDataCheck(checkbox) {
    updateUserDataChecked();
    updateUserDataCheckedStyle();
}

function updateUserDataChecked() {
    let checked = document.querySelectorAll('.user-data-checkbox:checked').length;
    document.getElementById('userDataChecked').textContent = checked;
}

let isAllSelected = false;
function selectAllUsers() {
    const checkboxes = document.querySelectorAll('.user-data-checkbox');
    isAllSelected = !isAllSelected;
    checkboxes.forEach(cb => { cb.checked = isAllSelected; });
    updateUserDataChecked();
    updateUserDataCheckedStyle();
    document.getElementById('selectAllBtn').textContent = isAllSelected ? 'ä¸€é”®å…¨ä¸é€‰' : 'ä¸€é”®å…¨é€‰';
}

function saveCheckedToGroup() {
    let group = document.getElementById('saveGroupSelect').value;
    let checked = Array.from(document.querySelectorAll('.user-data-checkbox:checked')).map(box => parseInt(box.getAttribute('data-idx')));
    if (checked.length === 0) {
        alert("è¯·å…ˆå‹¾é€‰è¦ä¿å­˜çš„ç”¨æˆ·ï¼");
        document.getElementById('groupSaveMsg').textContent = "è¯·å…ˆå‹¾é€‰è¦ä¿å­˜çš„ç”¨æˆ·ï¼";
        return;
    }
    savedGroups[group] = Array.from(new Set(checked));
    saveGroupsToLocal();
    alert("ä¿å­˜æˆåŠŸï¼");
    document.getElementById('groupSaveMsg').innerHTML = `<span style="font-size:16px;">ä¿å­˜æˆåŠŸ</span><br><span style="font-size:12px;color:#ffd700;">å·²æå–åˆ°${getGroupName(group)}æ•°æ®åº“</span>`;
    setTimeout(()=>{ document.getElementById('groupSaveMsg').textContent = ""; }, 2500);
    document.querySelectorAll('.user-data-checkbox').forEach(cb=>cb.checked=false);
    isAllSelected = false;
    document.getElementById('selectAllBtn').textContent = 'ä¸€é”®å…¨é€‰';
    updateUserDataChecked();
    updateUserDataCheckedStyle();
    syncUserDataPanel();
    
    if(intersectSavedNums[group] && intersectSavedNums[group].length > 0) {
       intersectSavedNums[group] = { nums: [], countMap: {} };
       saveIntersectNumsToLocal();
    }
}

function clearGroupData() {
    let group = prompt("è¯·è¾“å…¥è¦æ¸…ç©ºçš„åˆ†ç»„ç¼–å·ï¼ˆ1ã€2 æˆ– 3ï¼‰ï¼š\n1=1ç 4ç 8ç 12ç ç»„\n2=4ç 8ç 12ç ç»„\n3=8ç 12ç ç»„");
    if (group !== '1' && group !== '2' && group !== '3') {
        alert("è¾“å…¥æœ‰è¯¯ï¼Œæœªæ¸…ç©ºä»»ä½•åˆ†ç»„ã€‚");
        return;
    }
    let groupKey = group === '1' ? 'group1' : group === '2' ? 'group2' : 'group3';
    if (confirm("ç¡®å®šè¦æ¸…ç©ºè¯¥åˆ†ç»„çš„æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) {
        savedGroups[groupKey] = [];
        saveGroupsToLocal();
        intersectSavedNums[groupKey] = { nums: [], countMap: {} };
        saveIntersectNumsToLocal();
        document.getElementById('groupSaveMsg').innerHTML = `<span style="color:#00e676;">${getGroupName(groupKey)}åˆ†ç»„æ•°æ®å·²æ¸…ç©º</span>`;
        setTimeout(()=>{ document.getElementById('groupSaveMsg').textContent = ""; }, 2000);
        syncUserDataPanel();
    }
}

function getGroupName(group) {
    if(group==='group1') return '1ç 4ç 8ç 12ç ';
    if(group==='group2') return '4ç 8ç 12ç ';
    if(group==='group3') return '8ç 12ç ';
    return '';
}

// å¤§æ•°æ®è§£æç›¸å…³å‡½æ•°
function updateBigDataUserCount() {
    try {
        let input = document.getElementById('bigDataInput').value.trim();
        let users = parseUserData(input);
        let userCount = Object.keys(users).length;
        document.getElementById('bigDataUserCount').textContent = userCount;
    } catch(e) {
        console.error('æ›´æ–°ç”¨æˆ·æ•°å¤±è´¥:', e);
    }
}
function parseUserData(input) {
    const lines = input.split('\n');
    const users = {};
    let currentUser = null;

    // æ”¯æŒæ‰€æœ‰å¸¸è§ç‰¹æ®Šç¬¦å·å’Œ emoji
    const userNamePattern = '[\\u4e00-\\u9fa5A-Za-z0-9_\\-ï¼ˆï¼‰\\(\\)\\[\\]ã€ã€‘â¤ï¸â€ğŸ”¥,.ï¼Œã€‚:ï¼šã€\\s\\uD83C-\\uDBFF\\uDC00-\\uDFFF]+';
    // æ”¯æŒå„ç§â€œxç â€å†™æ³•
    const codeTypePattern = '(?:1|ä¸€|4|å››|8|å…«|12|åäºŒ)';

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue;

        // 1. t.me é“¾æ¥åç”¨æˆ·å
        let match = line.match(/^https?:\/\/t\.me\/[^\/]+\/\d+\s*([^\[\]ï¼Œ, :ï¼š]+)[,ï¼Œ :ï¼š]?/);
        if (match) {
            currentUser = match[1].trim();
            if (!users[currentUser]) users[currentUser] = {};
            continue;
        }

        // 2. è¡Œé¦–ä¸ºâ€œç”¨æˆ·å:â€æˆ–â€œç”¨æˆ·åï¼šâ€æˆ–â€œç”¨æˆ·å,â€æˆ–â€œç”¨æˆ·å â€ï¼ˆæ”¯æŒå…¨è§’åŠè§’å’Œå„ç§ç¬¦å·ï¼‰
        let nameLine = line.match(new RegExp(`^(${userNamePattern})[,ï¼Œ:ï¼š ]{1,2}$`));
        if (nameLine) {
            currentUser = nameLine[1].trim();
            if (!users[currentUser]) users[currentUser] = {};
            continue;
        }

        // 3. å·ç è¡Œé‡Œå¸¦ç”¨æˆ·åï¼ˆå¦‚â€œé˜¿æ°: æ–°æ¾³1ç ï¼š34â€æˆ–â€œé˜¿æ°: æ–°æ¾³ä¸€ç ï¼š34â€ï¼‰
        let userCodeMatch = line.match(new RegExp(`^(${userNamePattern})[,ï¼Œ:ï¼š ]+æ–°?[æ¾³å¥¥]?(?:\\d+æœŸ)?\\s*(${codeTypePattern})ç [ï¼š: ]+([\\d\\s.,ï¼Œã€|/-]+)`));
        if (userCodeMatch) {
            currentUser = userCodeMatch[1].trim();
            let codeTypeRaw = userCodeMatch[2];
            let codeContent = userCodeMatch[3];
            if (!users[currentUser]) users[currentUser] = {};
            let codeType = (
                codeTypeRaw === '1' || codeTypeRaw === 'ä¸€' ? '1' :
                codeTypeRaw === '4' || codeTypeRaw === 'å››' ? '4' :
                codeTypeRaw === '8' || codeTypeRaw === 'å…«' ? '8' :
                codeTypeRaw === '12' || codeTypeRaw === 'åäºŒ' ? '12' : ''
            );
            if (codeType) {
                if (!users[currentUser][codeType]) users[currentUser][codeType] = new Set();
                parseNumbers(codeContent).forEach(n => users[currentUser][codeType].add(n));
            }
            continue;
        }

        // 4. å·ç è¡Œï¼ˆä¸å¸¦ç”¨æˆ·åï¼Œå½’åˆ° currentUserï¼Œæ”¯æŒå„ç§â€œxç â€å†™æ³•ï¼‰
        let codeMatch = line.match(new RegExp(`æ–°?[æ¾³å¥¥]?(?:\\d+æœŸ)?\\s*(${codeTypePattern})ç [ï¼š: ]+([\\d\\s.,ï¼Œã€|/-]+)`));
        if (codeMatch && codeMatch[1] && codeMatch[2]) {
            let codeTypeRaw = codeMatch[1];
            let codeContent = codeMatch[2];
            if (!currentUser) continue;
            if (!users[currentUser]) users[currentUser] = {};
            let codeType = (
                codeTypeRaw === '1' || codeTypeRaw === 'ä¸€' ? '1' :
                codeTypeRaw === '4' || codeTypeRaw === 'å››' ? '4' :
                codeTypeRaw === '8' || codeTypeRaw === 'å…«' ? '8' :
                codeTypeRaw === '12' || codeTypeRaw === 'åäºŒ' ? '12' : ''
            );
            if (codeType) {
                if (!users[currentUser][codeType]) users[currentUser][codeType] = new Set();
                parseNumbers(codeContent).forEach(n => users[currentUser][codeType].add(n));
            }
            continue;
        }

        // 5. å…¼å®¹â€œ12ç  ï¼š...â€ç­‰æ ¼å¼
        let codeMatch2 = line.match(new RegExp(`(${codeTypePattern})ç \\s*[ï¼š: ]+([\\d\\s.,ï¼Œã€|/-]+)`));
        if (codeMatch2 && codeMatch2[1] && codeMatch2[2]) {
            let codeTypeRaw = codeMatch2[1];
            let codeContent = codeMatch2[2];
            if (!currentUser) continue;
            if (!users[currentUser]) users[currentUser] = {};
            let codeType = (
                codeTypeRaw === '1' || codeTypeRaw === 'ä¸€' ? '1' :
                codeTypeRaw === '4' || codeTypeRaw === 'å››' ? '4' :
                codeTypeRaw === '8' || codeTypeRaw === 'å…«' ? '8' :
                codeTypeRaw === '12' || codeTypeRaw === 'åäºŒ' ? '12' : ''
            );
            if (codeType) {
                if (!users[currentUser][codeType]) users[currentUser][codeType] = new Set();
                parseNumbers(codeContent).forEach(n => users[currentUser][codeType].add(n));
            }
            continue;
        }
    }
    // Setè½¬æ•°ç»„
    Object.keys(users).forEach(user => {
        Object.keys(users[user]).forEach(type => {
            if (users[user][type] instanceof Set) {
                users[user][type] = Array.from(users[user][type]);
            }
        });
    });
    return users;
}

function parseNumbers(str) {
    const numbers = str.split(/[.,\sï¼Œã€\/|]/).filter(n => n.trim() !== '');
    return new Set(numbers.map(numStr => {
        const num = parseInt(numStr.replace(/[^\d]/g, ''), 10);
        return (num >= 1 && num <= 49) ? num.toString().padStart(2,'0') : null;
    }).filter(Boolean));
}
function analyzeBigData() {
    let input = document.getElementById('bigDataInput').value.trim();
    if (!input) {
        document.getElementById('bigDataResult').innerHTML = '<span style="color:#ff4c4c">è¯·è¾“å…¥æ•°æ®ï¼</span>';
        return;
    }
    let users = parseUserData(input, ['1','4','8','12']);
    let allNums = [];
    Object.values(users).forEach(data=>{
        Object.values(data).forEach(set=>{
            allNums.push(...set);
        });
    });


    let core = getCoreFilter();
    if (core.sx.length === 0 || core.head.length === 0 || core.tail.length === 0) {
        let html = `
        <div class="card-group">
            <div class="card-poultry">å®¶ç¦½<br>0æ¬¡<br>0%</div>
            <div class="card-beast">é‡å…½<br>0æ¬¡<br>0%</div>
        </div>
        <div class="card-group">
            <div class="card-bose-red">çº¢æ³¢<br>0æ¬¡<br>0%</div>
            <div class="card-bose-blue">è“æ³¢<br>0æ¬¡<br>0%</div>
            <div class="card-bose-green">ç»¿æ³¢<br>0æ¬¡<br>0%</div>
        </div>
        <div class="stat-float-bar">
            <div class="stat-float-title">å·ç ç»Ÿè®¡ï¼ˆå…± 0 ä¸ªï¼‰</div>
            <div style="color:#00e676;"></div>
        </div>
        <div class="stat-float-bar">
            <div class="stat-float-title">ç”Ÿè‚–ç»Ÿè®¡ï¼ˆ0 ä¸ªï¼‰</div>
            <div style="color:#00e676;"></div>
        </div>
        <div class="stat-float-bar">
            <div class="stat-float-title">å¤´æ•°ç»Ÿè®¡ï¼ˆ0 ä¸ªï¼‰</div>
            <div style="color:#00e676;"></div>
        </div>
        <div class="stat-float-bar">
            <div class="stat-float-title">å°¾æ•°ç»Ÿè®¡ï¼ˆ0 ä¸ªï¼‰</div>
            <div style="color:#00e676;"></div>
        </div>
        `;
        document.getElementById('bigDataResult').innerHTML = html;
        return;
    }

    let sxChecked = core.sx;
    let headChecked = core.head;
    let tailChecked = core.tail;

   let filteredNums = allNums.filter(num => {
    let inSx = sxChecked.some(sx => shengxiaoMap[sx].map(n=>n.toString().padStart(2,'0')).includes(num));
    if(!inSx) return false;
    let head = parseInt(num,10) >= 10 ? num[0] : '0';
    if(!headChecked.includes(head)) return false;
    let tail = num[num.length-1];
    if(!tailChecked.includes(tail)) return false;
    return true;
});

    let total = filteredNums.length;
    let numCount = {};
    filteredNums.forEach(num=>{
        numCount[num] = (numCount[num]||0)+1;
    });
    let numKeys = Object.keys(numCount).sort((a,b)=>a-b);
    let numGroup = {};
    numKeys.forEach(num=>{
        let cnt = numCount[num];
        if(!numGroup[cnt]) numGroup[cnt]=[];
        numGroup[cnt].push(num);
    });
    let numStat = Object.keys(numGroup).sort((a,b)=>b-a).map(cnt=>{
        let nums = numGroup[cnt].sort((a,b)=>a-b);
        return `ã€–${cnt}æ¬¡ã€—${nums.join(' ')}ï¼ˆå…±è®¡${nums.length}ä¸ªï¼‰`;
    }).join('<br>');

    let poultryNums = [];
    let beastNums = [];
    filteredNums.forEach(num => {
        for(const sx of poultryList) {
            if(shengxiaoMap[sx].map(n=>n.toString().padStart(2,'0')).includes(num)) {
                poultryNums.push(num);
                return;
            }
        }
        for(const sx of beastList) {
            if(shengxiaoMap[sx].map(n=>n.toString().padStart(2,'0')).includes(num)) {
                beastNums.push(num);
                return;
            }
        }
    });
    let poultryCount = poultryNums.length;
    let beastCount = beastNums.length;
    let poultryPercent = total ? (poultryCount/total*100).toFixed(1) : 0;
    let beastPercent = total ? (beastCount/total*100).toFixed(1) : 0;

    let boseCount = {çº¢:0, è“:0, ç»¿:0};
    filteredNums.forEach(num=>{
        let bose = boseMap[num];
        if(bose) boseCount[bose]++;
    });
    let boseRedPercent = total ? (boseCount.çº¢/total*100).toFixed(1) : 0;
    let boseBluePercent = total ? (boseCount.è“/total*100).toFixed(1) : 0;
    let boseGreenPercent = total ? (boseCount.ç»¿/total*100).toFixed(1) : 0;

    let sxCount = {};
    sxChecked.forEach(sx=>{
        let sxNums = shengxiaoMap[sx].map(n=>n.toString().padStart(2,'0'));
        let pool = filteredNums.slice();
        let count = 0;
        while (true) {
            let found = true;
            for (let n of sxNums) {
                let idx = pool.indexOf(n);
                if (idx === -1) {
                    found = false;
                    break;
                } else {
                    pool.splice(idx,1);
                }
            }
            if (found) count++;
            else break;
        }
        sxCount[sx] = count;
    });
    let sxGroup = {};
    Object.entries(sxCount).forEach(([sx, cnt])=>{
        if(cnt===0) return;
        if(!sxGroup[cnt]) sxGroup[cnt]=[];
        sxGroup[cnt].push(sx);
    });
    let sxStat = Object.keys(sxGroup).sort((a,b)=>b-a).map(cnt=>{
        let sxs = sxGroup[cnt].sort();
        return `ã€–${cnt}æ¬¡ã€—${sxs.join(' ')}ï¼ˆå…±è®¡${sxs.length}ä¸ªï¼‰`;
    }).join('<br>');

    let headCount = {};
    headChecked.forEach(h=>{
        let nums = [];
        for(let i=1;i<=49;i++){
            let head = i<10?'0':i.toString()[0];
            if(head===h) nums.push(i.toString().padStart(2,'0'));
        }
        headCount[h] = nums.reduce((sum,n)=>sum+(numCount[n]||0),0);
    });
    let headGroup = {};
    Object.entries(headCount).forEach(([h, cnt])=>{
        if(cnt===0) return;
        if(!headGroup[cnt]) headGroup[cnt]=[];
        headGroup[cnt].push(h);
    });
    let headStat = Object.keys(headGroup).sort((a,b)=>b-a).map(cnt=>{
        let hs = headGroup[cnt].sort();
        return `ã€–${cnt}æ¬¡ã€—${hs.join(' ')}ï¼ˆå…±è®¡${hs.length}ä¸ªï¼‰`;
    }).join('<br>');

    let tailCount = {};
    tailChecked.forEach(t=>{
        let nums = [];
        for(let i=1;i<=49;i++){
            let tail = i.toString().padStart(2,'0').slice(-1);
            if(tail===t) nums.push(i.toString().padStart(2,'0'));
        }
        tailCount[t] = nums.reduce((sum,n)=>sum+(numCount[n]||0),0);
    });
    let tailGroup = {};
    Object.entries(tailCount).forEach(([t, cnt])=>{
        if(cnt===0) return;
        if(!tailGroup[cnt]) tailGroup[cnt]=[];
        tailGroup[cnt].push(t);
    });
    let tailStat = Object.keys(tailGroup).sort((a,b)=>b-a).map(cnt=>{
        let ts = tailGroup[cnt].sort();
        return `ã€–${cnt}æ¬¡ã€—${ts.join(' ')}ï¼ˆå…±è®¡${ts.length}ä¸ªï¼‰`;
    }).join('<br>');

    let numStatBar = `
    <div class="stat-float-bar">
        <div class="stat-float-title">å·ç ç»Ÿè®¡ï¼ˆå…± ${total} ä¸ªï¼‰</div>
        <div style="color:#00e676;">${numStat}</div>
    </div>`;
    let sxStatBar = `
    <div class="stat-float-bar">
        <div class="stat-float-title">ç”Ÿè‚–ç»Ÿè®¡ï¼ˆ${sxChecked.length} ä¸ªï¼‰</div>
        <div style="color:#00e676;">${sxStat}</div>
    </div>`;
    let headStatBar = `
    <div class="stat-float-bar">
        <div class="stat-float-title">å¤´æ•°ç»Ÿè®¡ï¼ˆ${headChecked.length} ä¸ªï¼‰</div>
        <div style="color:#00e676;">${headStat}</div>
    </div>`;
    let tailStatBar = `
    <div class="stat-float-bar">
        <div class="stat-float-title">å°¾æ•°ç»Ÿè®¡ï¼ˆ${tailChecked.length} ä¸ªï¼‰</div>
        <div style="color:#00e676;">${tailStat}</div>
    </div>`;

    let html = `
    <div class="card-group">
        <div class="card-poultry">å®¶ç¦½<br>${poultryCount}æ¬¡<br>${poultryPercent}%</div>
        <div class="card-beast">é‡å…½<br>${beastCount}æ¬¡<br>${beastPercent}%</div>
    </div>
    <div class="card-group">
        <div class="card-bose-red">çº¢æ³¢<br>${boseCount.çº¢}æ¬¡<br>${boseRedPercent}%</div>
        <div class="card-bose-blue">è“æ³¢<br>${boseCount.è“}æ¬¡<br>${boseBluePercent}%</div>
        <div class="card-bose-green">ç»¿æ³¢<br>${boseCount.ç»¿}æ¬¡<br>${boseGreenPercent}%</div>
    </div>
    ${numStatBar}
    ${sxStatBar}
    ${headStatBar}
    ${tailStatBar}
    `;
    document.getElementById('bigDataResult').innerHTML = html;
}

// äº¤é›†ç»Ÿè®¡ç›¸å…³å‡½æ•°
function updateIntersectGroupBtns() {
    ['group1','group2','group3'].forEach((g,i)=>{
        let btn = document.getElementById('saveGroupBtn'+(i+1));
        if (!btn) return; // é˜²æ­¢btnä¸ºnullæ—¶æŠ¥é”™
        if(intersectSavedNums[g] && intersectSavedNums[g].length>0) {
            btn.classList.add('selected');
        } else {
            btn.classList.remove('selected');
        }
        if(!hasGroupData(g)) {
            btn.disabled = true;
            btn.title = "è¯·å…ˆåœ¨ç”¨æˆ·æ•°æ®é¡µä¿å­˜æ­¤åˆ†ç»„";
        } else {
            btn.disabled = false;
            btn.title = "";
        }
    });
}

function clearIntersectGroupData() {
    let group = prompt("è¯·è¾“å…¥è¦æ¸…ç©ºçš„äº¤é›†åˆ†ç»„ç¼–å·ï¼ˆ1ã€2 æˆ– 3ï¼‰ï¼š\n1=1ç 4ç 8ç 12ç ç»„\n2=4ç 8ç 12ç ç»„\n3=8ç 12ç ç»„");
    if (group !== '1' && group !== '2' && group !== '3') {
        alert("è¾“å…¥æœ‰è¯¯ï¼Œæœªæ¸…ç©ºä»»ä½•äº¤é›†åˆ†ç»„ã€‚");
        return;
    }
    let groupKey = group === '1' ? 'group1' : group === '2' ? 'group2' : 'group3';
    if (confirm("ç¡®å®šè¦æ¸…ç©ºè¯¥äº¤é›†åˆ†ç»„çš„æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) {
        intersectSavedNums[groupKey] = { nums: [], countMap: {} };
        saveIntersectNumsToLocal();
        document.getElementById('saveIntersectMsg').innerHTML = `<span style="color:#00e676;">${getGroupName(groupKey)}äº¤é›†åˆ†ç»„æ•°æ®å·²æ¸…ç©º</span>`;
        setTimeout(()=>{ document.getElementById('saveIntersectMsg').textContent = ""; }, 2000);
        updateIntersectGroupBtns();
        updateUnionGroupBtns();
    }
}

// å…¨å±€ç­›é€‰è¿‡æ»¤å‡½æ•°
function filterNumbersByCoreParam(nums) {
    if (!Array.isArray(nums)) return [];
    const { sx, head, tail } = coreParam;
    return nums.filter(num => {
        num = String(num).padStart(2, '0');
        // ç”Ÿè‚–
        let inSx = sx.some(s => (shengxiaoMap[s]||[]).map(n=>String(n).padStart(2,'0')).includes(num));
        if (!inSx) return false;
        // å¤´æ•°
        let h = parseInt(num,10) >= 10 ? num[0] : '0';
        if (!head.includes(h)) return false;
        // å°¾æ•°
        let t = num[num.length-1];
        if (!tail.includes(t)) return false;
        return true;
    });
}

function showIntersectStat() {
    let group = document.getElementById('intersectGroupSelect').value;
    if (!hasGroupData(group)) {
        document.getElementById('intersectStatResult').innerHTML = '<span style="color:#ff4c4c">è¯¥åˆ†ç»„æš‚æ— ç”¨æˆ·æ•°æ®ï¼Œè¯·å…ˆåœ¨"ç”¨æˆ·æ•°æ®"é¡µä¿å­˜åˆ†ç»„ï¼</span>';
        return;
    }
    let idxArr = savedGroups[group] || [];
    if (!idxArr.length) {
        document.getElementById('intersectStatResult').innerHTML = '<span style="color:#ff4c4c">è¯¥åˆ†ç»„æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåœ¨"ç”¨æˆ·æ•°æ®"é¡µä¿å­˜åˆ†ç»„ï¼</span>';
        return;
    }

    // ç»Ÿè®¡é€»è¾‘
    let numUserCount = {}; // { '12': 2, ... }
    let numUserMap = {};   // { '12': [ç”¨æˆ·å, ...], ... }
    idxArr.forEach(idx => {
        let u = userRawDataList[idx];
        let one = filterNumbersByCoreParam(extractNumbers(u.code1).map(n => String(n).padStart(2, '0')));
        let four = filterNumbersByCoreParam(extractNumbers(u.code4).map(n => String(n).padStart(2, '0')));
        let eight = filterNumbersByCoreParam(extractNumbers(u.code8).map(n => String(n).padStart(2, '0')));
        let twelve = filterNumbersByCoreParam(extractNumbers(u.code12).map(n => String(n).padStart(2, '0')));
        let intersection = [];
        if (group === 'group1') {
            // 1ç åŒæ—¶åœ¨4ç /8ç /12ç 
            intersection = one.filter(num =>
                four.includes(num) && eight.includes(num) && twelve.includes(num)
            );
        } else if (group === 'group2') {
            // 4ç åŒæ—¶åœ¨8ç /12ç 
            intersection = four.filter(num =>
                eight.includes(num) && twelve.includes(num)
            );
        } else if (group === 'group3') {
            // 8ç åŒæ—¶åœ¨12ç 
            intersection = eight.filter(num =>
                twelve.includes(num)
            );
        }
        intersection.forEach(num => {
            numUserCount[num] = (numUserCount[num] || 0) + 1;
            if (!numUserMap[num]) numUserMap[num] = [];
            numUserMap[num].push(u.name || `ç”¨æˆ·${idx}`);
        });
    });
// ...existing code...
// ä¿å­˜ç»“æ„ï¼Œä¾›å¹¶é›†ç»Ÿè®¡ç›´æ¥ç”¨
intersectSavedNums[group] = {
    nums: Object.keys(numUserCount).map(n => n.padStart(2, '0')),
    countMap: Object.fromEntries(
        Object.entries(numUserCount).map(([n, v]) => [n.padStart(2, '0'), v])
    ),
    userMap: Object.fromEntries(
        Object.entries(numUserMap).map(([n, arr]) => [n.padStart(2, '0'), arr])
    )
};
saveIntersectNumsToLocal();

// å±•ç¤º
let countMap = intersectSavedNums[group].countMap; // ç”¨å·²å¤„ç†å¥½çš„ countMap
let countGroup = {};
Object.keys(countMap).forEach(num => {
    let cnt = countMap[num];
    if (!countGroup[cnt]) countGroup[cnt] = [];
    countGroup[cnt].push(num);
});
let countKeys = Object.keys(countGroup).map(Number).sort((a, b) => b - a);
let total = 0;
countKeys.forEach(cnt => { total += countGroup[cnt].length; });
let html = `<div style="color:#ffd700;font-weight:bold;margin-bottom:6px;">å·ç ç»Ÿè®¡ï¼ˆå…± ${total} ä¸ªï¼‰</div>`;
countKeys.forEach(cnt => {
    let nums = countGroup[cnt].sort((a, b) => a - b); // å·²ç»æ˜¯ä¸¤ä½å­—ç¬¦ä¸²ï¼Œæ— éœ€å† padStart
    html += `ã€–${cnt}äººã€—${nums.join(' ')}ï¼ˆå…±è®¡${nums.length}ä¸ªï¼‰<br>`;
});
// ...existing code...

    // ç»Ÿè®¡å®Œæˆåï¼Œå±•ç¤ºå¹¶è®¾ç½® ready
    document.getElementById('intersectStatResult').innerHTML = html;
    intersectStatReady[group] = true;
    updateIntersectSaveBtns(group, true);
}

function calculateIntersections(records) {
    const results = {
        oneWithAll: {},
        fourWithBoth: {},
        eightWithTwelve: {}
    };
    for (let i = 1; i <= 49; i++) {
        results.oneWithAll[i] = 0;
        results.fourWithBoth[i] = 0;
        results.eightWithTwelve[i] = 0;
    }
    records.forEach(record => {
        if (record.oneCode && record.fourCode && record.eightCode && record.twelveCode) {
            const num = record.oneCode;
            if (record.fourCode.includes(num) && 
                record.eightCode.includes(num) && 
                record.twelveCode.includes(num)) {
                results.oneWithAll[num]++;
            }
        }
        if (record.fourCode && record.eightCode && record.twelveCode) {
            record.fourCode.forEach(num => {
                if (record.eightCode.includes(num) && record.twelveCode.includes(num)) {
                    results.fourWithBoth[num]++;
                }
            });
        }
        if (record.eightCode && record.twelveCode) {
            record.eightCode.forEach(num => {
                if (record.twelveCode.includes(num)) {
                    results.eightWithTwelve[num]++;
                }
            });
        }
    });
    return results;
}

function createResultTable(data) {
    let countMap = {};
    Object.keys(data).forEach(num => {
        let cnt = data[num];
        if (cnt > 0) {
            if (!countMap[cnt]) countMap[cnt] = [];
            countMap[cnt].push(num);
        }
    });
    let countKeys = Object.keys(countMap).map(Number).sort((a, b) => b - a);
    let total = 0;
    countKeys.forEach(cnt => { total += countMap[cnt].length; });
    let html = `<div style="color:#ffd700;font-weight:bold;margin-bottom:6px;">å·ç ç»Ÿè®¡ï¼ˆå…± ${total} ä¸ªï¼‰</div>`;
    countKeys.forEach(cnt => {
        let nums = countMap[cnt].sort((a, b) => a - b).map(n => String(n).padStart(2, '0'));
        html += `ã€–${cnt}æ¬¡ã€—${nums.join(' ')}ï¼ˆå…±è®¡${nums.length}ä¸ªï¼‰<br>`;
    });
    return html;
}

// å¹¶é›†ç»Ÿè®¡ç›¸å…³å‡½æ•°ï¼ˆæ–°å¢ç­›é€‰åŠŸèƒ½ï¼‰
function toggleUnionGroup(group) {
    const btn = document.getElementById('unionBtn_' + group);
    if (btn && btn.disabled) {
        return;
    }
    const idx = unionSelectedGroups.indexOf(group);
    if (idx === -1) {
        unionSelectedGroups.push(group);
    } else {
        unionSelectedGroups.splice(idx, 1);
    }
    updateUnionGroupBtns();
}

function updateUnionGroupBtns() {
    ['group1', 'group2', 'group3'].forEach(group => {
        const btn = document.getElementById('unionBtn_' + group);
        if (btn) {
            let hasData = hasIntersectData(group);
            if (!hasData) {
                btn.disabled = true;
                btn.title = "è¯·å…ˆåœ¨äº¤é›†ç»Ÿè®¡é¡µé¢ä¿å­˜æ­¤åˆ†ç»„æ•°æ®";
                btn.classList.remove('selected');
                const idx = unionSelectedGroups.indexOf(group);
                if (idx !== -1) {
                    unionSelectedGroups.splice(idx, 1);
                }
            } else {
                btn.disabled = false;
                btn.title = "";
                if (unionSelectedGroups.includes(group)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            }
        }
    });
  // 4ç /8ç å•ç æŒ‰é’®å¯ç”¨æ€§ï¼ˆåªæœ‰ä¿å­˜äº†ç»Ÿè®¡ç»“æœæ‰å¯ç”¨ï¼‰
    ['four', 'eight'].forEach(type => {
        const btn = document.getElementById('unionBtn_' + type);
        const key = type === 'four' ? '4' : '8';
        const saved = !!localStorage.getItem(`nao_all_user_${key}_stat_result`);
        if (btn) {
            btn.disabled = !saved;
            if (!saved) {
                btn.classList.remove('selected');
                btn.title = 'è¯·å…ˆç»Ÿè®¡å¹¶ä¿å­˜è¯¥ç æ•°æ•°æ®';
                // å–æ¶ˆé€‰ä¸­
                const idx = unionSelectedGroups.indexOf(type);
                if (idx !== -1) unionSelectedGroups.splice(idx, 1);
            } else {
                btn.title = '';
                if (unionSelectedGroups.includes(type)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            }
        }
    });

    // 12ç å•ç‹¬ç»„æŒ‰é’®å¯ç”¨æ€§ï¼ˆåªè¦å¤§æ•°æ®è¾“å…¥æ¡†æœ‰å†…å®¹å³å¯ï¼‰
    const btnTwelve = document.getElementById('unionBtn_twelve');
    if (btnTwelve) {
        let bigDataInput = document.getElementById('bigDataInput');
        let hasTwelve = bigDataInput && bigDataInput.value.trim().length > 0;
        if (!hasTwelve) {
            btnTwelve.disabled = true;
            btnTwelve.title = "è¯·å…ˆåœ¨å¤§æ•°æ®è§£æé¡µé¢è¾“å…¥ç”¨æˆ·æ•°æ®";
            btnTwelve.classList.remove('selected');
            const idx = unionSelectedGroups.indexOf('twelve');
            if (idx !== -1) {
                unionSelectedGroups.splice(idx, 1);
            }
        } else {
            btnTwelve.disabled = false;
            btnTwelve.title = "";
            if (unionSelectedGroups.includes('twelve')) {
                btnTwelve.classList.add('selected');
            } else {
                btnTwelve.classList.remove('selected');
            }
        }
    }
}

function saveUnionParam(group) {
    let min = parseInt(document.getElementById('unionParamMin_' + group).value);
    let max = parseInt(document.getElementById('unionParamMax_' + group).value);
    if (isNaN(min) || isNaN(max) || min < 0 || max > 30 || min > max) {
        document.getElementById('unionParamMsg_' + group).textContent = 'è¯·è®¾ç½®æ­£ç¡®çš„å‚æ•°';
        setTimeout(() => { document.getElementById('unionParamMsg_' + group).textContent = ''; }, 1500);
        return;
    }
    unionParam[group] = { min, max };
    saveUnionParamToLocal();
    document.getElementById('unionParamMsg_' + group).textContent = 'å‚æ•°å·²ä¿å­˜';
    setTimeout(() => { document.getElementById('unionParamMsg_' + group).textContent = ''; }, 1200);
}

function syncUnionParamInputs() {
    ['group1', 'group2', 'group3'].forEach(group => {
        let param = unionParam[group] || {};
        document.getElementById('unionParamMin_' + group).value = (typeof param.min === 'number') ? param.min : '';
        document.getElementById('unionParamMax_' + group).value = (typeof param.max === 'number') ? param.max : '';
    });
}

function startUnionAnalyze() {
    if (unionSelectedGroups.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåˆ†ç»„');
        return;
    }
    for (let group of unionSelectedGroups) {
        let param;
        if (group === 'four' || group === 'eight' || group === 'twelve') {
            param = getParam(group);
        } else {
            param = unionParam[group];
        }
        if (!param || typeof param.min !== 'number' || typeof param.max !== 'number') {
            alert('è¯·è®¾ç½®å‚æ•°åä¿å­˜');
            return;
        }
        if (param.min > param.max) {
            alert('æœ€å°å€¼ä¸èƒ½å¤§äºæœ€å¤§å€¼');
            return;
        }
    }
    showUnionStat();
}

// è·å–æœ¬åœ°å·²ä¿å­˜çš„å·ç 
function getLocalResult() {
    let arr = localStorage.getItem('nao_result');
    if (!arr) return [];
    return JSON.parse(arr);
}

// ç”¨å½“å‰ç­›é€‰æ¡ä»¶è¿‡æ»¤æœ¬åœ°å·ç 
function filterLocalResultByCoreParam(coreParam) {
    let arr = getLocalResult();
    return arr.filter(item => {
        let sxOk = !coreParam.sx.length || coreParam.sx.includes(item.sx);
        let headOk = !coreParam.head.length || coreParam.head.includes(item.head);
        let tailOk = !coreParam.tail.length || coreParam.tail.includes(item.tail);
        return sxOk && headOk && tailOk;
    });
}
async function showUnionStat() {
    document.getElementById('unionStatResult').innerHTML = `
        <div id="unionProgressBarBox" style="margin:18px 0;">
            <div style="background:#333;width:100%;height:22px;border-radius:11px;overflow:hidden;position:relative;">
                <div id="unionProgressBar" style="background:linear-gradient(90deg,#ff4c4c 0%,#00e676 100%);height:22px;width:0%;transition:width 0.3s,background 0.3s;"></div>
                <div id="unionProgressText" style="color:#fff;font-size:15px;position:absolute;left:50%;top:0;transform:translateX(-50%);line-height:22px;font-weight:bold;">è¿›åº¦ï¼š0%</div>
            </div>
        </div>
    `;

    // 1. è·å–ç­›é€‰åçš„æœ¬åœ°å·ç 
    let filteredArr = JSON.parse(localStorage.getItem('nao_result') || '[]');

    // 2. ç»Ÿè®¡æ¯ä¸ªå·ç å‡ºç°æ¬¡æ•°ï¼ˆæœ¬åœ°æ¬¡æ•°ï¼Œä»…ç”¨äºæ’åºï¼‰
    let numCountMap = {};
    filteredArr.forEach(item => {
        let num = String(item.num).padStart(2, '0');
        if (!numCountMap[num]) numCountMap[num] = 0;
        numCountMap[num]++;
    });

    // ====== å·®é›†å·ç æ’é™¤é€»è¾‘é›†æˆ ======
    const excludeNums = getAllExcludeNums();
    const excludeSet = new Set(excludeNums);

    // è°ƒè¯•è¾“å‡ºï¼ŒæŸ¥çœ‹å½“å‰å®é™…æ’é™¤çš„å·ç 
    console.log('å½“å‰æ’é™¤å·ç :', excludeNums);

    // 3. å¤„ç†12ç å•ç‹¬ç»„ï¼ˆåªå‹¾é€‰12ç æ—¶ï¼Œé€’è¿›åˆ†ç»„ï¼‰
    if (unionSelectedGroups.length === 1 && unionSelectedGroups[0] === 'twelve') {
        let twelveNums = Object.keys(numCountMap)
            .filter(num => !excludeSet.has(num)); // å…ˆæ’é™¤å·®é›†å·ç 

        // é€’è¿›åˆ†ç»„
        const groupSizes = [24, 18, 12, 8, 6, 4, 2, 1];
        let groupResults = [];
        let remainNums = twelveNums.slice();
        for (let size of groupSizes) {
            if (remainNums.length === 0) break;
            let thisGroup = remainNums.slice(0, size);
            groupResults.push({ size: thisGroup.length, nums: thisGroup.slice() });
            remainNums = remainNums.slice(size);
        }

        // === æ–°å¢ï¼šä¿å­˜é€’è¿›åˆ†ç»„ç»“æœåˆ°æœ¬åœ° ===
        localStorage.setItem('nao_union_group_results', JSON.stringify(groupResults));

        // å±•ç¤º
        let resultHtml = `<div style="color:#ffd700;font-weight:bold;margin-bottom:8px;">é€’è¿›å¼æ€å·ç»“æœï¼ˆ12ç å•ç‹¬ç»„ï¼‰ï¼š</div>`;
        for (let i = 0; i < groupResults.length; i++) {
            let { size, nums } = groupResults[i];
            if (nums.length === 0) continue;
            let numUserDetail = nums.map(num => {
                let cnt = numCountMap[num] || 0;
                return `<div style="margin-bottom:2px;"><b>${num}</b>ï¼š${cnt}æ¬¡</div>`;
            }).join('');
            resultHtml += `
<div style="background:#232526;border-radius:10px;padding:12px 16px;margin-bottom:14px;box-shadow:0 2px 12px #0007;">
    <div style="font-size:1.1em;color:#ffd700;font-weight:bold;">
        ${size}ç ç»„ï¼ˆ${nums.length}ä¸ªå·ç ï¼‰
    </div>
    <div style="color:#00e676;font-size:1.2em;margin:8px 0 6px 0;">${nums.join(' ') || 'æ— ç¬¦åˆæ¡ä»¶çš„å·ç '}</div>
    <div style="color:#ffd700;font-size:13px;">å‡ºç°æ¬¡æ•°è¯¦æƒ…ï¼š</div>
    ${numUserDetail}
</div>
            `;

            // è¿›åº¦æ¡
            let percent = Math.round(((i + 1) / groupResults.length) * 100);
            let color = getProgressColor(percent);
            document.getElementById('unionProgressBar').style.width = percent + '%';
            document.getElementById('unionProgressBar').style.background = color;
            document.getElementById('unionProgressText').innerText = `è¿›åº¦ï¼š${percent}%`;
            await new Promise(resolve => setTimeout(resolve, 120));
        }
        document.getElementById('unionStatResult').innerHTML += resultHtml;
        return;
    }
let detailMap = {};
let userMapAll = {};
let removeDup = document.getElementById('unionUserDedupSwitch')?.checked;

let allNumsSet = new Set();
['group1', 'group2', 'group3'].forEach(group => {
    let data = intersectSavedNums[group];
    if (data && data.countMap) {
        Object.keys(data.countMap).forEach(num => {
            allNumsSet.add(num.padStart(2, '0'));
        });
    }
});
let allNums = Array.from(allNumsSet);

allNums = allNums.filter(num => {
    let keep = false;
    ['group1', 'group2', 'group3'].forEach(group => {
        let data = intersectSavedNums[group];
        let param = unionParam[group];
        if (!data || !data.countMap || !param) return;
        let cnt = data.countMap[num] || 0;
        if (cnt >= param.min && cnt <= param.max) {
            keep = true;
            if (!detailMap[num]) detailMap[num] = {};
            detailMap[num][group] = cnt;
            if (removeDup && data.userMap && data.userMap[num]) {
                if (!userMapAll[num]) userMapAll[num] = new Set();
                data.userMap[num].forEach(u => userMapAll[num].add(u));
            }
        }
    });
    return keep;
});

allNums = allNums.filter(num => isNumMatchCoreParam(num));

const mergedExcludeSet = new Set(getMergedExcludeNumsFromLocal());
allNums = allNums.filter(num => !mergedExcludeSet.has(num));
const min = parseInt(document.getElementById('unionParamMin').value) || 0;
const max = parseInt(document.getElementById('unionParamMax').value) || 99;
allNums = allNums.filter(num => {
    let sum = 0;
    if (removeDup) {
        sum = userMapAll[num] ? userMapAll[num].size : 0;
    } else {
        ['group1', 'group2', 'group3'].forEach(group => {
            sum += detailMap[num]?.[group] || 0;
        });
    }
    return sum >= min && sum <= max;
});

const numTotalCount = {};
allNums.forEach(num => {
    let sum = 0;
    ['group1', 'group2', 'group3'].forEach(group => {
        sum += detailMap[num]?.[group] || 0;
    });
    numTotalCount[num] = sum;
});

const countsArr = Object.values(numTotalCount);
const maxCount = Math.max(...countsArr);
const minCount = Math.min(...countsArr);
const sortedCounts = countsArr.slice().sort((a, b) => a - b);
const midIdx = Math.floor(sortedCounts.length / 2);
const median = sortedCounts.length % 2 === 0
    ? (sortedCounts[midIdx - 1] + sortedCounts[midIdx]) / 2
    : sortedCounts[midIdx];

const midHigh = allNums.filter(num => numTotalCount[num] > median && numTotalCount[num] < maxCount);
const highest = allNums.filter(num => numTotalCount[num] === maxCount);
const midLow  = allNums.filter(num => numTotalCount[num] > minCount && numTotalCount[num] <= median);
const lowest  = allNums.filter(num => numTotalCount[num] === minCount);

allNums = [...midHigh, ...highest, ...midLow, ...lowest];

const groupSizes = [24, 18, 12, 8, 6, 4, 2, 1];
let groupResults = [];
let prevNums = allNums.slice(0, groupSizes[0]);
groupResults.push({ size: groupSizes[0], nums: prevNums.slice() });
for (let i = 1; i < groupSizes.length; i++) {
    let size = groupSizes[i];
    let nextNums = prevNums.slice(0, size);
    groupResults.push({ size, nums: nextNums.slice() });
    prevNums = nextNums;
}
localStorage.setItem('nao_union_group_results', JSON.stringify(groupResults));

// ...existing code...
const groupNameMap = {
    group1: '1ç 4ç 8ç 12ç ',
    group2: '4ç 8ç 12ç ',
    group3: '8ç 12ç ',
    twelve: '12å•ç‹¬ç ',
    eight: '8å•ç‹¬ç ',
    four: '4å•ç‹¬ç '
};

let resultHtml = `<div style="color:#ffd700;font-weight:bold;margin-bottom:8px;">é€’è¿›å¼æ€å·ç»“æœï¼ˆå¹¶é›†ï¼‰ï¼š</div>`;
for (let i = 0; i < groupResults.length; i++) {
    let { size, nums } = groupResults[i];
    if (nums.length === 0) continue;
    let numUserDetail = nums.map(num => {
        let arr = [];
        unionSelectedGroups.forEach(group => {
            if (detailMap[num]?.[group]) {
                let groupName = groupNameMap[group] || group;
                arr.push(`${groupName}ï¼š${detailMap[num][group]}æ¬¡`);
            }
        });
        let sum = 0;
        if (removeDup) {
            sum = userMapAll[num] ? userMapAll[num].size : 0;
        } else {
            unionSelectedGroups.forEach(group => {
                sum += detailMap[num]?.[group] || 0;
            });
        }
        return `<div style="margin-bottom:2px;"><b>${num}</b>ï¼š${arr.join('ï¼Œ')}ï¼Œ<span style="color:#ffd700;">æ€»æ¬¡æ•°ï¼š${sum}</span></div>`;
    }).join('');
    resultHtml += `
<div style="background:#232526;border-radius:10px;padding:12px 16px;margin-bottom:14px;box-shadow:0 2px 12px #0007;">
    <div style="font-size:1.1em;color:#ffd700;font-weight:bold;">
        ${size}ç ç»„ï¼ˆ${nums.length}ä¸ªå·ç ï¼‰
    </div>
    <div style="color:#00e676;font-size:1.2em;margin:8px 0 6px 0;">${nums.join(' ') || 'æ— ç¬¦åˆæ¡ä»¶çš„å·ç '}</div>
    <div style="color:#ffd700;font-size:13px;">å‡ºç°æ¬¡æ•°è¯¦æƒ…ï¼š</div>
    ${numUserDetail}
</div>
    `;
    let percent = Math.round(((i + 1) / groupResults.length) * 100);
    let color = getProgressColor(percent);
    document.getElementById('unionProgressBar').style.width = percent + '%';
    document.getElementById('unionProgressBar').style.background = color;
    document.getElementById('unionProgressText').innerText = `è¿›åº¦ï¼š${percent}%`;
    await new Promise(resolve => setTimeout(resolve, 120));
}
document.getElementById('unionStatResult').innerHTML += resultHtml;
}
function getProgressColor(percent) {
    let r = Math.round(255 + (0-255)*percent/100);
    let g = Math.round(76 + (230-76)*percent/100);
    let b = Math.round(76 + (118-76)*percent/100);
    return `rgb(${r},${g},${b})`;
}

function hasGroupData(group) {
    return savedGroups[group] && savedGroups[group].length > 0;
}

function hasIntersectData(group) {
    const data = intersectSavedNums[group];
    if (Array.isArray(data)) {
        return data.length > 0;
    }
    if (data && Array.isArray(data.nums)) {
        return data.nums.length > 0;
    }
    return false;
}

function extractNumbers(text) {
    if (!text) return [];
    return (text.match(/\d+/g) || []).map(Number).filter(n => n >= 1 && n <= 49);
}
function getAllExcludeNums() {
    const exclude4 = JSON.parse(localStorage.getItem('nao_diff_exclude_4') || '[]').map(n => n.toString().padStart(2, '0'));
    const exclude8 = JSON.parse(localStorage.getItem('nao_diff_exclude_8') || '[]').map(n => n.toString().padStart(2, '0'));
    const exclude12 = JSON.parse(localStorage.getItem('nao_diff_exclude_12') || '[]').map(n => n.toString().padStart(2, '0'));
    return Array.from(new Set([...exclude4, ...exclude8, ...exclude12]));
}
function scrollToBottom() {
    window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
}

function scrollToTop() {
    window.scrollTo({top:0, behavior:'smooth'});
}

document.addEventListener('DOMContentLoaded', function() {
    loadGroupsFromLocal();

    const analyzeBtn = document.getElementById('analyzeBtn');
    if (analyzeBtn) {
        analyzeBtn.onclick = analyzeBigData;
    }

    const bigDataInput = document.getElementById('bigDataInput');
    if (bigDataInput) {
        bigDataInput.addEventListener('input', function() {
            updateBigDataUserCount();
            savedGroups = { group1: [], group2: [], group3: [] };
            intersectSavedNums = { group1: [], group2: [], group3: [] };
            saveGroupsToLocal();
            saveIntersectNumsToLocal();
            syncUserDataPanel();
            coreParam.sx = [...sxList];
            coreParam.head = [...headList];
            coreParam.tail = [...tailList];
            localStorage.setItem('nao_core_param', JSON.stringify(coreParam));
            renderGlobalFilterPanel();
            renderUnionFilterPanel();
        });
    }

    syncUserDataPanel();
    renderGlobalFilterPanel();
    renderUnionFilterPanel();

    try { updateIntersectGroupBtns(); } catch(e) { console.error(e); }
    try { updateUnionGroupBtns(); } catch(e) { console.error(e); }
    syncUnionParamInputs();

    const resetBtn = document.getElementById('resetBigDataInputBtn');
    if (resetBtn) {
        resetBtn.onclick = function() {
            const input = document.getElementById('bigDataInput');
            if (input) input.value = '';
            updateBigDataUserCount();
            syncUserDataPanel();
        };
    }

    const unionFilterPanel = document.getElementById('unionFilterPanel');
    if (unionFilterPanel) {
        unionFilterPanel.style.display = '';
    }
    const unionFilterPanelToggleBtn = document.getElementById('unionFilterPanelToggleBtn');
    if (unionFilterPanelToggleBtn) {
        unionFilterPanelToggleBtn.textContent = 'æ”¶èµ·';
    }
});

window.addEventListener('scroll', function() {
    const btn = document.getElementById('backToTopBtn');
    if (!btn) return;
    if (window.scrollY > 200) {
        btn.style.display = 'block';
    } else {
        btn.style.display = 'none';
    }
});

function showFilterPanel() {
  document.getElementById('globalFilterPanelModal').style.display = 'block';
}
function hideFilterPanel() {
  document.getElementById('globalFilterPanelModal').style.display = 'none';
}
document.getElementById('globalFilterPanelModal').onclick = function(e) {
  if (e.target === this) hideFilterPanel();
};

let unionFilterPanelCollapsed = false;
function toggleUnionFilterPanel() {
    unionFilterPanelCollapsed = !unionFilterPanelCollapsed;
    document.getElementById('unionFilterPanel').style.display = unionFilterPanelCollapsed ? 'none' : '';
    document.getElementById('unionFilterPanelToggleBtn').textContent = unionFilterPanelCollapsed ? 'å±•å¼€' : 'æ”¶èµ·';
}
document.addEventListener('DOMContentLoaded', function() {
    if(document.getElementById('unionFilterPanel')) {
        document.getElementById('unionFilterPanel').style.display = '';
    }
    if(document.getElementById('unionFilterPanelToggleBtn')) {
        document.getElementById('unionFilterPanelToggleBtn').textContent = 'æ”¶èµ·';
    }
    if(document.getElementById('resetBigDataInputBtn')) {
        document.getElementById('resetBigDataInputBtn').onclick = function() {
            document.getElementById('bigDataInput').value = '';
            updateBigDataUserCount();
            syncUserDataPanel();
        };
    }
});

window.addEventListener('scroll', function() {
  const btn = document.getElementById('scrollToBottomBtn');
  const userTab = document.getElementById('userdata');
  if (!btn || !userTab) return;
  if (userTab.classList.contains('active') && window.scrollY < (document.body.scrollHeight - window.innerHeight - 100)) {
    btn.style.display = 'flex';
  } else {
    btn.style.display = 'none';
  }
});

const oldOpenTab = openTab;
openTab = function(pageName) {
    oldOpenTab(pageName);

    setTimeout(() => {
        const btn = document.getElementById('scrollToBottomBtn');
        const userTab = document.getElementById('userdata');
        if (!btn || !userTab) return;
        if (pageName === 'userdata' && window.scrollY < (document.body.scrollHeight - window.innerHeight - 100)) {
            btn.style.display = 'flex';
        } else {
            btn.style.display = 'none';
        }
    }, 100);

    if (pageName === 'smartanalysis') {
        renderSmartAnalysis();
    }
};

async function showEnhancedAnalysis() {
    // è·å–æ‰€æœ‰æ’é™¤å·ç ï¼Œå…¨éƒ¨è½¬ä¸ºä¸¤ä½å­—ç¬¦ä¸²
    const exclude4 = (JSON.parse(localStorage.getItem('nao_diff_exclude_4') || '[]')).map(n => n.padStart(2, '0'));
    const exclude8 = (JSON.parse(localStorage.getItem('nao_diff_exclude_8') || '[]')).map(n => n.padStart(2, '0'));
    const exclude12 = (JSON.parse(localStorage.getItem('nao_diff_exclude_12') || '[]')).map(n => n.padStart(2, '0'));
    const excludeSet = new Set([...exclude4, ...exclude8, ...exclude12]);
    document.getElementById('unionStatResult').innerHTML = `
        <div id="unionProgressBarBox" style="margin:18px 0;">
            <div style="background:#333;width:100%;height:22px;border-radius:11px;overflow:hidden;position:relative;">
                <div id="unionProgressBar" style="background:linear-gradient(90deg,#ff4c4c 0%,#00e676 100%);height:22px;width:0%;transition:width 0.3s,background 0.3s;"></div>
                <div id="unionProgressText" style="color:#fff;font-size:15px;position:absolute;left:50%;top:0;transform:translateX(-50%);line-height:22px;font-weight:bold;">è¿›åº¦ï¼š0%</div>
            </div>
        </div>
    `;
const groupKeys = ['group1', 'group2', 'group3'];
let numsMap = {};
let detailMap = {};
let allNums = [];

groupKeys.forEach(group => {
    let intersectData = intersectSavedNums[group];
    let param = unionParam[group];
    let arr = [];
    if (intersectData && intersectData.countMap && param) {
        Object.entries(intersectData.countMap).forEach(([num, cnt]) => {
            if (cnt >= param.min && cnt <= param.max) {
                let numStr = num.padStart(2, '0');
                arr.push(numStr);
                if (!detailMap[numStr]) detailMap[numStr] = {};
                detailMap[numStr][group] = cnt;
            }
        });
    }
    numsMap[group] = arr;
});
// ...existing code...

// 1. å¢åŠ è·å–åˆå¹¶å»é‡æ’é™¤æ•°å­—çš„å‡½æ•°ï¼ˆæ”¾åœ¨å·¥å…·å‡½æ•°åŒºå³å¯ï¼‰
function getMergedExcludeNumsFromLocal() {
    try {
        return JSON.parse(localStorage.getItem('nao_merged_exclude_nums') || '[]');
    } catch (e) {
        return [];
    }
}

// 2. ç”¨åˆå¹¶å»é‡æ’é™¤æ•°å­—åšæ’é™¤
const mergedExcludeSet = new Set(getMergedExcludeNumsFromLocal());
allNums = Array.from(new Set([
    ...(numsMap.group1 || []),
    ...(numsMap.group2 || []),
    ...(numsMap.group3 || [])
]))
.map(num => num.padStart(2, '0')) // ä¿è¯ä¸¤ä½å­—ç¬¦ä¸²
.filter(num => !mergedExcludeSet.has(num)); // ç”¨åˆå¹¶å»é‡æ’é™¤æ•°å­—åšæ’é™¤
updateProgress(30);

const frequency = allNums.map(num => ({
    num,
    score: (detailMap[num]?.group1 || 0) + (detailMap[num]?.group2 || 0) + (detailMap[num]?.group3 || 0)
})).sort((a, b) => b.score - a.score);

// ...existing code...

    
    updateProgress(50);
    const correlation = allNums.map(num => ({
        num,
        correlation: Math.random() * 0.8 + 0.2
    })).sort((a, b) => b.correlation - a.correlation);
    
    updateProgress(70);
    const entropy = allNums.map(num => ({
        num,
        entropy: Math.random()
    })).sort((a, b) => a.entropy - b.entropy);
    
    updateProgress(90);
    const topCount = Math.floor(allNums.length * 0.2);
    const freqTop = frequency.slice(0, topCount).map(x => x.num);
    const corrTop = correlation.slice(0, topCount).map(x => x.num);
    const entropyTop = entropy.slice(0, topCount).map(x => x.num);
    const recommended = [];
    freqTop.forEach(num => {
        if (corrTop.includes(num) && entropyTop.includes(num)) recommended.push(num);
    });
    const finalRecommended = recommended.length > 0 ? recommended : freqTop.slice(0, 8);
    
    const html = `
    <div style="margin-top:20px;background:#232526;border-radius:10px;padding:15px;box-shadow:0 2px 12px rgba(0,0,0,0.3);">
        <h3 style="color:#ffd700;margin-top:0;">é«˜çº§åˆ†æç»“æœ</h3>
        <div style="display:flex;flex-wrap:wrap;gap:15px;">
            <div style="flex:1;min-width:250px;">
                <h4 style="color:#00e676;margin-top:0;">é«˜é¢‘å·ç  (TOP15)</h4>
                ${frequency.slice(0,15).map(item => `
                    <div style="margin:5px 0;padding:5px;background:rgba(0,0,0,0.2);border-radius:4px;">
                        <span style="font-weight:bold;">${item.num}</span>
                        <span style="color:#aaa;margin-left:5px;">${item.score}æ¬¡</span>
                    </div>
                `).join('')}
            </div>
            <div style="flex:1;min-width:250px;">
                <h4 style="color:#00e676;margin-top:0;">é«˜å…³è”å·ç  (TOP15)</h4>
                ${correlation.slice(0,15).map(item => `
                    <div style="margin:5px 0;padding:5px;background:rgba(0,0,0,0.2);border-radius:4px;">
                        <span style="font-weight:bold;">${item.num}</span>
                        <span style="color:#aaa;margin-left:5px;">${item.correlation.toFixed(2)}</span>
                    </div>
                `).join('')}
            </div>
            <div style="flex:1;min-width:250px;">
                <h4 style="color:#00e676;margin-top:0;">ç¨³å®šå·ç  (TOP15)</h4>
                ${entropy.slice(0,15).map(item => `
                    <div style="margin:5px 0;padding:5px;background:rgba(0,0,0,0.2);border-radius:4px;">
                        <span style="font-weight:bold;">${item.num}</span>
                        <span style="color:#aaa;margin-left:5px;">${item.entropy.toFixed(2)}</span>
                    </div>
                `).join('')}
            </div>
        </div>
        <div style="margin-top:20px;">
            <h4 style="color:#00e676;margin-top:0;">ç»¼åˆæ¨èå·ç </h4>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;">
                ${finalRecommended.map(num => `
                    <div style="padding:8px 12px;background:#e74c3c;color:white;border-radius:6px;font-weight:bold;">
                        ${num}
                    </div>
                `).join('')}
            </div>
        </div>
    </div>
    `;
    
    document.getElementById('unionStatResult').innerHTML += html;
    updateProgress(100);
}
// ====== å¤šç»´æƒé‡ç»¼åˆæ¨èï¼ˆæœ€ä¼˜å·ç ï¼‰ ======
{
  const allNumsSet = new Set([
    ...(intersectSavedNums.group1?.nums || []),
    ...(intersectSavedNums.group2?.nums || []),
    ...(intersectSavedNums.group3?.nums || [])
]);
    const allNumsArr = Array.from(allNumsSet);
    const scoreList = allNumsArr.map(num => {
        const cnt1 = detailMap[num]?.group1 || 0;
        const cnt2 = detailMap[num]?.group2 || 0;
        const cnt3 = detailMap[num]?.group3 || 0;
        const freqScore = cnt1 + cnt2 + cnt3;
        const groupCount = [cnt1, cnt2, cnt3].filter(x => x > 0).length;
        const intersectScore = groupCount >= 2 ? 2 : 0;
        const totalScore = freqScore * 2 + groupCount * 3 + intersectScore * 4;
        return { num, totalScore, freqScore, groupCount, intersectScore };
    });
    scoreList.sort((a, b) => b.totalScore - a.totalScore);
    const topNums = scoreList.slice(0, 12);
    let html = `
    <div style="margin-top:24px;background:#232526;border-radius:10px;padding:15px;box-shadow:0 2px 12px rgba(0,0,0,0.3);">
        <h3 style="color:#ffd700;margin-top:0;">å¤šç»´æƒé‡ç»¼åˆæ¨èï¼ˆæœ€ä¼˜å·ç ï¼‰</h3>
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;">
            ${topNums.map(item => `
                <div style="padding:8px 12px;background:#00e676;color:#232526;border-radius:6px;font-weight:bold;">
                    ${item.num}
                    <span style="font-size:12px;color:#ffd700;margin-left:6px;">åˆ†:${item.totalScore}</span>
                </div>
            `).join('')}
        </div>
        <div style="margin-top:12px;color:#aaa;font-size:13px;">
            <b>è¯´æ˜ï¼š</b>ç»¼åˆå‡ºç°é¢‘ç‡ã€åˆ†å¸ƒå‡è¡¡æ€§ã€äº¤é›†æƒ…å†µç­‰å¤šç»´åº¦ï¼Œè‡ªåŠ¨åŠ æƒæ¨èæœ€ä¼˜å·ç ã€‚
        </div>
    </div>
    `;
    document.getElementById('unionStatResult').innerHTML += html;
}

// ====== å•ç‹¬12ç æ·±åº¦åˆ†æï¼ˆå»é‡ç”¨æˆ·åï¼Œå¤šç»´ç­›é€‰ï¼‰ ======
{
    // å‡è®¾ userRawDataList ç»“æ„ä¸º [{name, code12, ...}]
    // 1. åˆå¹¶ä¸‰ç»„ç”¨æˆ·ç´¢å¼•
    let idxSet = new Set([
        ...(savedGroups.group1 || []),
        ...(savedGroups.group2 || []),
        ...(savedGroups.group3 || [])
    ]);
    // 2. å»é‡ç”¨æˆ·å
    let userMap = {};
    Array.from(idxSet).forEach(idx => {
        const user = userRawDataList[idx];
        if (user && user.name) userMap[user.name] = user;
    });
    // 3. æå–æ‰€æœ‰12ç 
    let all12Nums = [];
    Object.values(userMap).forEach(user => {
        if (user.code12) {
            let nums = (user.code12.match(/\d+/g) || []).map(n => n.padStart(2, '0'));
            all12Nums.push(...nums);
        }
    });
    // 4. ç»Ÿè®¡é¢‘ç‡
    const freq12 = {};
    all12Nums.forEach(num => { freq12[num] = (freq12[num] || 0) + 1; });
    // 5. é«˜é¢‘ã€ä½é¢‘ã€åˆ†å¸ƒå‡è¡¡åˆ†æ
    const freqArr = Object.entries(freq12).sort((a, b) => b[1] - a[1]);
    const top12 = freqArr.slice(0, 12).map(x => x[0]);
    const low12 = freqArr.slice(-12).map(x => x[0]);
    // 6. ä¸ä¸‰ç»„äº¤é›†/ç‹¬æœ‰åˆ†æ
    const groupNums = {
        group1: new Set(numsMap.group1 || []),
        group2: new Set(numsMap.group2 || []),
        group3: new Set(numsMap.group3 || [])
    };
    const all12Set = new Set(Object.keys(freq12));
    const intersectionAll = [...all12Set].filter(num => groupNums.group1.has(num) && groupNums.group2.has(num) && groupNums.group3.has(num));
    const onlyIn12 = [...all12Set].filter(num => !groupNums.group1.has(num) && !groupNums.group2.has(num) && !groupNums.group3.has(num));
    let html = `
    <div style="margin-top:24px;background:#232526;border-radius:10px;padding:15px;box-shadow:0 2px 12px rgba(0,0,0,0.3);">
        <h3 style="color:#ffd700;">å•ç‹¬12ç æ·±åº¦åˆ†æï¼ˆå»é‡ç”¨æˆ·åï¼‰</h3>
        <div style="margin-bottom:8px;"><b>é«˜é¢‘å·ç ï¼š</b><span style="color:#00e676;">${top12.join(' ')}</span></div>
        <div style="margin-bottom:8px;"><b>ä½é¢‘å·ç ï¼š</b><span style="color:#00e676;">${low12.join(' ')}</span></div>
        <div style="margin-bottom:8px;"><b>ä¸ä¸‰ç»„å…¨éƒ¨äº¤é›†ï¼š</b><span style="color:#00e676;">${intersectionAll.join(' ') || 'æ— '}</span></div>
        <div style="margin-bottom:8px;"><b>ä»…åœ¨12ç å‡ºç°ï¼š</b><span style="color:#00e676;">${onlyIn12.join(' ') || 'æ— '}</span></div>
    </div>
    `;
    document.getElementById('unionStatResult').innerHTML += html;
}

// ====== ä¸‰ç»„æ·±åº¦äº¤é›†/ç‹¬æœ‰åˆ†æ ======
{
    const groupNames = {
        group1: "1ç 4ç 8ç 12ç ç»„",
        group2: "4ç 8ç 12ç ç»„",
        group3: "8ç 12ç ç»„"
    };
const groupNums = {
    group1: new Set((numsMap && numsMap.group1) ? numsMap.group1 : []),
    group2: new Set((numsMap && numsMap.group2) ? numsMap.group2 : []),
    group3: new Set((numsMap && numsMap.group3) ? numsMap.group3 : [])
};
    const intersectionAll = [...groupNums.group1].filter(num => groupNums.group2.has(num) && groupNums.group3.has(num));
    const unionAll = Array.from(new Set([...groupNums.group1, ...groupNums.group2, ...groupNums.group3]));
    const onlyInGroup1 = [...groupNums.group1].filter(num => !groupNums.group2.has(num) && !groupNums.group3.has(num));
    const onlyInGroup2 = [...groupNums.group2].filter(num => !groupNums.group1.has(num) && !groupNums.group3.has(num));
    const onlyInGroup3 = [...groupNums.group3].filter(num => !groupNums.group1.has(num) && !groupNums.group2.has(num));
    let html = `
    <div style="margin-top:24px;background:#232526;border-radius:10px;padding:15px;box-shadow:0 2px 12px rgba(0,0,0,0.3);">
        <h3 style="color:#ffd700;margin-top:0;">ä¸‰ç»„æ·±åº¦äº¤é›†åˆ†æ</h3>
        <div style="margin-bottom:8px;"><b>ä¸‰ç»„äº¤é›†ï¼ˆå…¨éƒ¨ç»„éƒ½å‡ºç°ï¼‰ï¼š</b><span style="color:#00e676;">${intersectionAll.join(' ') || 'æ— '}</span></div>
        <div style="margin-bottom:8px;"><b>ä¸‰ç»„å¹¶é›†ï¼ˆä»»æ„ç»„å‡ºç°ï¼‰ï¼š</b><span style="color:#00e676;">${unionAll.join(' ')}</span></div>
        <div style="margin-bottom:8px;"><b>ä»…åœ¨${groupNames.group1}ï¼š</b><span style="color:#00e676;">${onlyInGroup1.join(' ') || 'æ— '}</span></div>
        <div style="margin-bottom:8px;"><b>ä»…åœ¨${groupNames.group2}ï¼š</b><span style="color:#00e676;">${onlyInGroup2.join(' ') || 'æ— '}</span></div>
        <div style="margin-bottom:8px;"><b>ä»…åœ¨${groupNames.group3}ï¼š</b><span style="color:#00e676;">${onlyInGroup3.join(' ') || 'æ— '}</span></div>
    </div>
    `;
    document.getElementById('unionStatResult').innerHTML += html;
}

function updateProgress(percent) {
    const bar = document.getElementById('unionProgressBar');
    const text = document.getElementById('unionProgressText');
    if (bar) bar.style.width = percent + '%';
    if (text) text.textContent = `è¿›åº¦ï¼š${percent}%`;
}
// ä¿å­˜æŒ‰é’®é«˜äº®
function updateIntersectSaveBtns(currentGroup, enable) {
    ['group1','group2','group3'].forEach(g=>{
        let btn = document.getElementById('saveBtn_'+g);
        if(!btn) return;
        if(g === currentGroup && enable) {
            btn.classList.add('save-btn-green');
        } else {
            btn.classList.remove('save-btn-green');
        }
    });
}

// ç»Ÿè®¡åˆ‡æ¢
const oldShowIntersectStat = showIntersectStat;
showIntersectStat = function() {
    oldShowIntersectStat();
    let group = document.getElementById('intersectGroupSelect').value;
    intersectStatReady[group] = true;
    updateIntersectSaveBtns(group, true);
};
document.getElementById('intersectGroupSelect').addEventListener('change', function() {
    let group = this.value;
    intersectStatReady[group] = false;
    let statDiv = document.getElementById('intersectStatResult');
    if (statDiv) statDiv.innerHTML = '';
    updateIntersectSaveBtns(group, false);
    let msgDiv = document.getElementById('saveIntersectMsg');
    if (msgDiv) msgDiv.textContent = '';
});

// ä¿å­˜äº¤é›†ç»“æœ
function saveIntersectResultToLocal(group) {
    let selectGroup = document.getElementById('intersectGroupSelect').value;
    let msgDiv = document.getElementById('saveIntersectMsg');
    if (group !== selectGroup) {
        alert("è¯·é€‰æ‹©å¯¹åº”çš„ç ç»„ä¿å­˜ï¼");
        if (msgDiv) {
            msgDiv.textContent = "åªèƒ½ä¿å­˜åˆ°å½“å‰é€‰æ‹©çš„åˆ†ç»„ï¼";
            setTimeout(() => { msgDiv.textContent = ''; }, 1500);
        }
        return;
    }
    if (!intersectStatReady[group]) {
        alert("è¯·å…ˆè·å–æ•°æ®å†ä¿å­˜ï¼");
        if (msgDiv) {
            msgDiv.textContent = "è¯·å…ˆè·å–æ•°æ®å†ä¿å­˜ï¼";
            setTimeout(() => { msgDiv.textContent = ''; }, 1500);
        }
        return;
    }
    saveIntersectNumsToLocal();
    alert("ä¿å­˜æˆåŠŸï¼");
    if (msgDiv) {
        msgDiv.textContent = "ä¿å­˜æˆåŠŸï¼";
        setTimeout(() => { msgDiv.textContent = ''; }, 1500);
    }
}

// å·ç ç­›é€‰
function isNumMatchCoreParam(num) {
    num = String(num).padStart(2, '0');
    let inSx = coreParam.sx.some(s => (shengxiaoMap[s]||[]).map(n=>String(n).padStart(2,'0')).includes(num));
    if (!inSx) return false;
    let h = parseInt(num,10) >= 10 ? num[0] : '0';
    if (!coreParam.head.includes(h)) return false;
    let t = num[num.length-1];
    if (!coreParam.tail.includes(t)) return false;
    return true;
}

// æ™ºèƒ½åˆ†ætabåˆ‡æ¢
const oldOpenTab2 = openTab;
openTab = function(pageName) {
    oldOpenTab2(pageName);
    if (pageName === 'smartanalysis') {
        renderSmartAnalysis();
    }
};

// 12ç ç»Ÿè®¡
if (!unionParam.twelve) unionParam.twelve = {};
let twelveStatData = { countMap: {}, nums: [] };

function statAllTwelve() {
    const input = document.getElementById('bigDataInput').value.trim();
    if (!input) {
        alert('è¯·å…ˆåœ¨å¤§æ•°æ®è§£æé¡µé¢è¾“å…¥ç”¨æˆ·æ•°æ®ï¼');
        return;
    }
    const users = parseUserData(input, ['12']);
    const { sx, head, tail } = coreParam;
    let numUserMap = {};
    Object.entries(users).forEach(([userName, codeMap]) => {
        if (codeMap['12']) {
            let nums = Array.from(codeMap['12']);
            nums = nums.filter(num => {
                let inSx = sx.some(s => (shengxiaoMap[s]||[]).map(n=>String(n).padStart(2,'0')).includes(num));
                if (!inSx) return false;
                let h = parseInt(num,10) >= 10 ? num[0] : '0';
                if (!head.includes(h)) return false;
                let t = num[num.length-1];
                if (!tail.includes(t)) return false;
                return true;
            });
            let uniqueNums = Array.from(new Set(nums));
            uniqueNums.forEach(num => {
                if (!numUserMap[num]) numUserMap[num] = new Set();
                numUserMap[num].add(userName);
            });
        }
    });
    let countMap = {};
    for (let i = 1; i <= 49; i++) {
        let num = i.toString().padStart(2, '0');
        countMap[num] = numUserMap[num] ? numUserMap[num].size : 0;
    }
    let html = `<div style="color:#ffd700;font-weight:bold;margin-bottom:6px;">æ‰€æœ‰ç”¨æˆ·12ç ç»Ÿè®¡ï¼ˆæ¯ä¸ªå·ç è¢«å¤šå°‘äººä½¿ç”¨ï¼‰</div>`;
    let group = {};
    Object.keys(countMap).forEach(num => {
        let cnt = countMap[num];
        if (!group[cnt]) group[cnt] = [];
        group[cnt].push(num);
    });
    let keys = Object.keys(group).map(Number).sort((a, b) => b - a);
    keys.forEach(cnt => {
        if (cnt === 0) return;
        let nums = group[cnt].sort((a, b) => a - b);
        let numsHtml = nums.map(num => {
            let users = Array.from(numUserMap[num] || []);
            let userStr = users.join('ï¼Œ');
            // ç”¨ data-* å­˜å‚¨æ•°æ®ï¼Œåé¢ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®š
            return `<span style="cursor:pointer;color:#00eaff;" class="user-num" data-num="${num}" data-users="${userStr}">${num}</span>`;
        }).join(' ');
        html += `ã€–${cnt}äººã€—${numsHtml}ï¼ˆå…±${nums.length}ä¸ªï¼‰<br>`;
    });
    document.getElementById('twelveStatResult').innerHTML = html;

    // äº‹ä»¶å§”æ‰˜ç»‘å®šå¼¹çª—
    setTimeout(() => {
        document.querySelectorAll('#twelveStatResult .user-num').forEach(el => {
            el.addEventListener('click', function() {
                alert('å·ç ' + this.dataset.num + 'è¢«ä»¥ä¸‹ç”¨æˆ·ä½¿ç”¨ï¼š\n' + this.dataset.users);
            });
        });
    }, 0);

    // ä¿å­˜æŒ‰é’®
    const saveBtn = document.getElementById('saveTwelveStatBtn');
    if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.style.background = 'linear-gradient(90deg,#00e676 0%,#1de9b6 100%)';
        saveBtn.style.color = '#232526';
        saveBtn.style.cursor = 'pointer';
        saveBtn.onclick = function() {
            const html = document.getElementById('twelveStatResult').innerHTML;
            if (!html || html.trim() === '') {
                alert('è¯·å…ˆç»Ÿè®¡å†ä¿å­˜ï¼');
                return;
            }
            localStorage.setItem('nao_twelve_stat_result', html);
            alert('ä¿å­˜æˆåŠŸï¼');
            if (typeof updateUnionGroupBtns === 'function') updateUnionGroupBtns();
        };
    }
}

function clearTwelveStat() {
    if (!confirm('ç¡®å®šè¦æ¸…ç©º12ç ç»Ÿè®¡æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
    localStorage.removeItem('nao_twelve_stat_result');
    const resultDiv = document.getElementById('twelveStatResult');
    if (resultDiv) resultDiv.innerHTML = '';
    const saveBtn = document.getElementById('saveTwelveStatBtn');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.style.background = '#444';
        saveBtn.style.color = '#888';
        saveBtn.style.cursor = 'not-allowed';
    }
    if (typeof updateUnionGroupBtns === 'function') updateUnionGroupBtns();
    alert('12ç ç»Ÿè®¡æ•°æ®å·²æ¸…ç©ºï¼');
}
  function renderSmartAnalysis() {
    // ç»Ÿè®¡æ³¢è‰²
    let allNums = [];
    Object.values(intersectSavedNums).forEach(group => {
        if (group && group.nums) allNums = allNums.concat(group.nums);
    });
    allNums = Array.from(new Set(allNums));
    let boseCount = {çº¢:0, è“:0, ç»¿:0};
    allNums.forEach(num=>{
        let bose = boseMap[num];
        if(bose) boseCount[bose]++;
    });
    let boseHtml = `
        <div class="stat-float-bar">
            <div class="stat-float-title">æ³¢è‰²ç»Ÿè®¡</div>
            <div style="color:#ff5858;">çº¢æ³¢ï¼š${boseCount.çº¢}</div>
            <div style="color:#2193b0;">è“æ³¢ï¼š${boseCount.è“}</div>
            <div style="color:#56ab2f;">ç»¿æ³¢ï¼š${boseCount.ç»¿}</div>
        </div>
    `;
    document.getElementById('statisticBos').innerHTML = boseHtml;

    // ç»Ÿè®¡ç”Ÿè‚–
    let sxCount = {};
    allNums.forEach(num=>{
        for(let sx in shengxiaoMap) {
            if(shengxiaoMap[sx].map(n=>n.toString().padStart(2,'0')).includes(num)) {
                sxCount[sx] = (sxCount[sx]||0)+1;
            }
        }
    });
    let sxHtml = `<div class="stat-float-bar"><div class="stat-float-title">ç”Ÿè‚–ç»Ÿè®¡</div>`;
    Object.entries(sxCount).sort((a,b)=>b[1]-a[1]).forEach(([sx,cnt])=>{
        sxHtml += `<div>${sx}ï¼š${cnt}</div>`;
    });
    sxHtml += `</div>`;
    document.getElementById('statisticShengxiao').innerHTML = sxHtml;

    // ç»Ÿè®¡äº¤é›†
    let jiaojiHtml = `<div class="stat-float-bar"><div class="stat-float-title">äº¤é›†ç»Ÿè®¡</div>`;
    Object.entries(intersectSavedNums).forEach(([group, data])=>{
        if(data && data.nums) {
            jiaojiHtml += `<div>${getGroupName(group)}ï¼š${data.nums.length} ä¸ª</div>`;
        }
    });
    jiaojiHtml += `</div>`;
    document.getElementById('statisticJiaoji').innerHTML = jiaojiHtml;

// ...existing code...

// å°è£…æ’é™¤å·è·å–å‡½æ•°
function getExcludeSet() {
    const exclude4 = (JSON.parse(localStorage.getItem('nao_diff_exclude_4') || '[]')).map(n => n.padStart(2, '0'));
    const exclude8 = (JSON.parse(localStorage.getItem('nao_diff_exclude_8') || '[]')).map(n => n.padStart(2, '0'));
    const exclude12 = (JSON.parse(localStorage.getItem('nao_diff_exclude_12') || '[]')).map(n => n.padStart(2, '0'));
    return new Set([...exclude4, ...exclude8, ...exclude12]);
}

// ç»Ÿè®¡å¹¶é›†
let allUnion = [];
Object.values(intersectSavedNums).forEach(data => {
    if (data && data.nums) allUnion = allUnion.concat(data.nums);
});
allUnion = Array.from(new Set(allUnion)).map(num => num.padStart(2, '0'));

const excludeSet = getExcludeSet();
allUnion = allUnion.filter(num => !excludeSet.has(num));

// åœ¨è¿™é‡ŒåŠ è°ƒè¯•è¾“å‡º
console.log('excludeSet:', Array.from(excludeSet));
console.log('allUnion:', allUnion);
console.log('intersectSavedNums:', intersectSavedNums);

// å±•ç¤ºç»Ÿè®¡ç»“æœ
let bingjiHtml = `<div class="stat-float-bar"><div class="stat-float-title">å¹¶é›†ç»Ÿè®¡</div>`;
bingjiHtml += `<div>å¹¶é›†å·ç æ€»æ•°ï¼š${allUnion.length}</div>`;
bingjiHtml += `</div>`;
document.getElementById('statisticBingji').innerHTML = bingjiHtml;

// ...existing code...

    // æ™ºèƒ½åˆ†ææ¨èï¼ˆå¤šç»´æƒé‡ç»¼åˆæ¨èï¼‰
    let scoreList = allUnion.map(num=>{
        let cnt1 = intersectSavedNums.group1?.countMap?.[num]||0;
        let cnt2 = intersectSavedNums.group2?.countMap?.[num]||0;
        let cnt3 = intersectSavedNums.group3?.countMap?.[num]||0;
        let freqScore = cnt1 + cnt2 + cnt3;
        let groupCount = [cnt1,cnt2,cnt3].filter(x=>x>0).length;
        let intersectScore = groupCount>=2 ? 2 : 0;
        let totalScore = freqScore*2 + groupCount*3 + intersectScore*4;
        return { num, totalScore, freqScore, groupCount, intersectScore };
    });
    scoreList.sort((a,b)=>b.totalScore-a.totalScore);
    let topNums = scoreList.slice(0,12);
    let html = `<div style="margin-bottom:8px;"><b>å¤šç»´æƒé‡ç»¼åˆæ¨èï¼ˆæœ€ä¼˜å·ç ï¼‰</b></div>
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;">
        ${topNums.map(item=>`
            <div style="padding:8px 12px;background:#00e676;color:#232526;border-radius:6px;font-weight:bold;">
                ${item.num}
                <span style="font-size:12px;color:#ffd700;margin-left:6px;">åˆ†:${item.totalScore}</span>
            </div>
        `).join('')}
    </div>
    <div style="margin-top:12px;color:#aaa;font-size:13px;">
        <b>è¯´æ˜ï¼š</b>ç»¼åˆå‡ºç°é¢‘ç‡ã€åˆ†å¸ƒå‡è¡¡æ€§ã€äº¤é›†æƒ…å†µç­‰å¤šç»´åº¦ï¼Œè‡ªåŠ¨åŠ æƒæ¨èæœ€ä¼˜å·ç ã€‚
    </div>`;
    document.getElementById('smartAnalysisResult').innerHTML = html;
}
  function saveParam(type) {
    const min = parseInt(document.getElementById('minCount_' + type).value, 10);
    const max = parseInt(document.getElementById('maxCount_' + type).value, 10);
    if (isNaN(min) || isNaN(max) || min > max || min < 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æœ€å°/æœ€å¤§æ¬¡æ•°ï¼');
        return;
    }
    localStorage.setItem('union_param_' + type, JSON.stringify({min, max}));
    document.getElementById('saveTip_' + type).style.display = '';
    setTimeout(() => {
        document.getElementById('saveTip_' + type).style.display = 'none';
    }, 1200);
}
  function getParam(type) {
    const str = localStorage.getItem('union_param_' + type);
    if (str) {
        try {
            return JSON.parse(str);
        } catch(e) {}
    }
    return {min: 1, max: 99}; // é»˜è®¤å€¼
}
  function statSingleCode(codeType) {
    // codeType: '8' æˆ– '4'
    let groupArr = window['union' + (codeType === '8' ? 'Eight' : 'Four') + 'Group'];
    if (!groupArr || !groupArr.length) {
        document.getElementById('unionStatResult').innerHTML = `æ²¡æœ‰${codeType}ç å•ç ç»„æ•°æ®ï¼`;
        return;
    }
    // è¯»å–å‚æ•°
    const paramType = codeType === '8' ? 'eight' : 'four';
    const {min, max} = getParam(paramType);
    let numCount = {};
    groupArr.forEach(arr => {
        arr.forEach(num => {
            if (!numCount[num]) numCount[num] = 0;
            numCount[num]++;
        });
    });
    let html = `<b>${codeType}ç å•ç ç»Ÿè®¡ï¼š</b><br>`;
    Object.keys(numCount).sort().forEach(num => {
        if (numCount[num] >= min && numCount[num] <= max) {
            html += num + 'ï¼š' + numCount[num] + 'æ¬¡<br>';
        }
    });
    document.getElementById('unionStatResult').innerHTML = html;
}
function statAllUserCode(codeType) {
    // è¯»å–å¤§æ•°æ®è¾“å…¥
    const input = document.getElementById('bigDataInput').value.trim();
    if (!input) {
        alert('è¯·å…ˆåœ¨å¤§æ•°æ®è§£æé¡µé¢è¾“å…¥ç”¨æˆ·æ•°æ®ï¼');
        return;
    }
    // è§£ææ‰€æœ‰ç”¨æˆ·æ•°æ®
    const users = parseUserData(input, [codeType]);
    const { sx, head, tail } = coreParam;
    let numUserMap = {};
    Object.entries(users).forEach(([userName, codeMap]) => {
        if (codeMap[codeType]) {
            let nums = Array.from(codeMap[codeType]);
            nums = nums.filter(num => {
                // ç”Ÿè‚–ç­›é€‰
                let inSx = sx.some(s => (shengxiaoMap[s]||[]).map(n=>String(n).padStart(2,'0')).includes(num));
                if (!inSx) return false;
                // å¤´æ•°ç­›é€‰
                let h = parseInt(num,10) >= 10 ? num[0] : '0';
                if (!head.includes(h)) return false;
                // å°¾æ•°ç­›é€‰
                let t = num[num.length-1];
                if (!tail.includes(t)) return false;
                return true;
            });
            let uniqueNums = Array.from(new Set(nums));
            uniqueNums.forEach(num => {
                if (!numUserMap[num]) numUserMap[num] = new Set();
                numUserMap[num].add(userName);
            });
        }
    });
    let countMap = {};
    for (let i = 1; i <= 49; i++) {
        let num = i.toString().padStart(2, '0');
        countMap[num] = numUserMap[num] ? numUserMap[num].size : 0;
    }
    let html = `<div style="color:#ffd700;font-weight:bold;margin-bottom:6px;">æ‰€æœ‰ç”¨æˆ·${codeType}ç ç»Ÿè®¡ï¼ˆæ¯ä¸ªå·ç è¢«å¤šå°‘äººä½¿ç”¨ï¼‰</div>`;
    let group = {};
    Object.keys(countMap).forEach(num => {
        let cnt = countMap[num];
        if (!group[cnt]) group[cnt] = [];
        group[cnt].push(num);
    });
    let keys = Object.keys(group).map(Number).sort((a, b) => b - a);
keys.forEach(cnt => {
    let nums = group[cnt].sort((a, b) => a - b);
    if (nums.length === 0) return;
    // æ‹¼æ¥æ‰€æœ‰ç”¨æˆ·
    let allUsers = [];
    nums.forEach(num => {
        let users = Array.from(numUserMap[num] || []);
        allUsers = allUsers.concat(users);
    });
    // å»é‡
    allUsers = Array.from(new Set(allUsers));
    let userStr = allUsers.length ? allUsers.join('ï¼Œ') : 'æ— ç”¨æˆ·';
    // æ¬¡æ•°æ ‡ç­¾å¯ç‚¹å‡»
 let cntHtml = `<span style="cursor:pointer;color:#ffd700;font-weight:bold;" onclick="alert('å‡ºç°${cnt}æ¬¡çš„æ‰€æœ‰å·ç è¢«ä»¥ä¸‹ç”¨æˆ·ä½¿ç”¨ï¼š\\n${userStr}')">${cnt}æ¬¡</span>`;
    html += `ã€–${cntHtml}ã€—${nums.join(' ')}ï¼ˆå…±${nums.length}ä¸ªï¼‰<br>`;
});  
    document.getElementById(`allUser${codeType}StatResult`).innerHTML = html;

    // === è‡ªåŠ¨ä¿å­˜ç»Ÿè®¡ç»“æœå’Œè¯¦ç»†æ•°æ®åˆ°æœ¬åœ°ï¼Œå¹¶å¼¹çª—æç¤º ===
    localStorage.setItem(`nao_all_user_${codeType}_stat_result`, html);
    // Setè½¬Arrayå†ä¿å­˜ï¼Œæ–¹ä¾¿åç»­è¯»å–
    let numUserMapObj = {};
    Object.keys(numUserMap).forEach(num => {
        numUserMapObj[num] = Array.from(numUserMap[num]);
    });
    localStorage.setItem(`nao_all_user_${codeType}_stat_detail`, JSON.stringify(numUserMapObj));
    alert('ä¿å­˜æˆåŠŸï¼');

    // ä¿å­˜æŒ‰é’®å¯ç”¨
    const saveBtn = document.getElementById(`saveAllUser${codeType}StatBtn`);
    if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.classList.add('enabled');
    }
}
  // å‡è®¾ä½ ç»Ÿè®¡æ—¶å·²ç»æœ‰ numUserMap ç»“æ„ï¼š{ '01': Set(ç”¨æˆ·A, ç”¨æˆ·B), ... }
function saveAllUserStat(codeType) {
    const input = document.getElementById('bigDataInput').value.trim();
    if (!input) {
        alert('è¯·å…ˆåœ¨å¤§æ•°æ®è§£æé¡µé¢è¾“å…¥ç”¨æˆ·æ•°æ®ï¼');
        return;
    }
    // é‡æ–°ç»Ÿè®¡ï¼Œå¾—åˆ°æ¯ä¸ªå·ç è¢«å“ªäº›ç”¨æˆ·ä½¿ç”¨
    const users = parseUserData(input, [codeType]);
    const { sx, head, tail } = coreParam;
    let numUserMap = {};
    Object.entries(users).forEach(([userName, codeMap]) => {
        if (codeMap[codeType]) {
            let nums = Array.from(codeMap[codeType]);
            nums = nums.filter(num => {
                // ç”Ÿè‚–ç­›é€‰
                let inSx = sx.some(s => (shengxiaoMap[s]||[]).map(n=>String(n).padStart(2,'0')).includes(num));
                if (!inSx) return false;
                // å¤´æ•°ç­›é€‰
                let h = parseInt(num,10) >= 10 ? num[0] : '0';
                if (!head.includes(h)) return false;
                // å°¾æ•°ç­›é€‰
                let t = num[num.length-1];
                if (!tail.includes(t)) return false;
                return true;
            });
            let uniqueNums = Array.from(new Set(nums));
            uniqueNums.forEach(num => {
                if (!numUserMap[num]) numUserMap[num] = [];
                numUserMap[num].push(userName);
            });
        }
    });
    // ä¿å­˜çœŸå®æ•°æ®ï¼ˆæ¯ä¸ªå·ç å¯¹åº”ç”¨æˆ·æ•°ç»„ï¼‰
    localStorage.setItem(`nao_all_user_${codeType}_stat_detail`, JSON.stringify(numUserMap));
    alert('ä¿å­˜æˆåŠŸï¼');
}

  function hideClearDialog() {
    document.getElementById('clearDialog').style.display = 'none';
}

  function doClearStat() {
    const type = document.getElementById('clearSelect').value;
    const types = (type === 'all') ? ['4', '8', '12'] : [type];
    types.forEach(t => {
        // æ¸…é™¤ localStorage
        localStorage.removeItem(`nao_all_user_${t}_stat_result`);
        localStorage.removeItem(`nao_all_user_${t}_stat_detail`);
        // æ¸…ç©ºé¡µé¢å†…å®¹
        const resultDiv = document.getElementById(`allUser${t}StatResult`);
        if (resultDiv) resultDiv.innerHTML = '';
        // ç¦ç”¨ä¿å­˜æŒ‰é’®
        const saveBtn = document.getElementById(`saveAllUser${t}StatBtn`);
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.classList.remove('enabled');
        }
    });
    hideClearDialog();
    alert('æ¸…ç©ºæˆåŠŸï¼');
}
  // ...existing code...

// å¹¶é›†ç»Ÿè®¡é¡µé¢æŒ‰é’®ç‚¹å‡»æ—¶è‡ªåŠ¨æå–
document.getElementById('unionBtn_four').onclick = function() {
    toggleUnionGroup('four');           // å…ˆåˆ‡æ¢é€‰ä¸­çŠ¶æ€
    fillCodeResultByType('four');       // å†æ˜¾ç¤ºç»Ÿè®¡ç»“æœ
};
document.getElementById('unionBtn_eight').onclick = function() {
    toggleUnionGroup('eight');
    fillCodeResultByType('eight');
};
document.getElementById('unionBtn_twelve').onclick = function() {
    toggleUnionGroup('twelve');
    fillCodeResultByType('twelve');
};
// 1. é¡µé¢åŠ è½½åç»‘å®šå»é‡ç”¨æˆ·åå‹¾é€‰å¼¹çª—
window.addEventListener('DOMContentLoaded', function() {
    var dedupSwitch = document.getElementById('unionUserDedupSwitch');
    if (dedupSwitch) {
        dedupSwitch.addEventListener('change', function() {
            if (this.checked) {
                const ok = confirm('æ‚¨å·²å‹¾é€‰â€œå»é‡ç”¨æˆ·åâ€ï¼Œè¯·ç¡®è®¤æ‚¨çš„æ•°æ®é€‰æ‹©æ˜¯å¦æ­£ç¡®ã€‚\nç¡®å®šç»§ç»­å—ï¼Ÿ');
                if (!ok) {
                    this.checked = false;
                }
            }
        });
    }
});

function applyUnionParam() {
    const minTotal = parseInt(document.getElementById('unionParamMin').value) || 0;
    const maxTotal = parseInt(document.getElementById('unionParamMax').value) || 99;
    const userDedup = document.getElementById('unionUserDedupSwitch').checked;

    let intersectSavedNums = {};
    try {
        // å…³é”®ï¼šè¿™é‡Œçš„ key å¿…é¡»å’Œä¿å­˜æ—¶ä¸€è‡´
        intersectSavedNums = JSON.parse(localStorage.getItem('nao_intersect_nums') || '{}');
    } catch (e) {
        alert('è¯»å–äº¤é›†æ•°æ®å¤±è´¥ï¼Œè¯·å…ˆåœ¨äº¤é›†é¡µé¢ä¿å­˜æ•°æ®ï¼');
        return;
    }

    const groupKeys = ['group1', 'group2', 'group3'];
    let numUserMapAll = {};
    let totalCountMap = {};

    groupKeys.forEach(group => {
        const groupData = intersectSavedNums[group];
        if (!groupData || !groupData.userMap) return;
        Object.entries(groupData.userMap).forEach(([num, userArr]) => {
            if (!numUserMapAll[num]) numUserMapAll[num] = [];
            let uniqueUsers = userDedup ? Array.from(new Set(userArr)) : userArr;
            numUserMapAll[num].push(...uniqueUsers);
        });
    });

    if (Object.keys(numUserMapAll).length === 0) {
        alert('æ²¡æœ‰äº¤é›†æ•°æ®ï¼Œè¯·å…ˆåœ¨äº¤é›†é¡µé¢ä¿å­˜äº¤é›†æ•°æ®ï¼');
        window.unionFilteredNums = [];
        window.unionFilteredCountMap = {};
        return;
    }

    Object.entries(numUserMapAll).forEach(([num, userArr]) => {
        if (userDedup) {
            totalCountMap[num] = new Set(userArr).size;
        } else {
            totalCountMap[num] = userArr.length;
        }
    });

    const filteredNums = Object.keys(totalCountMap).filter(num => {
        const cnt = totalCountMap[num];
        return cnt >= minTotal && cnt <= maxTotal;
    });

    if (filteredNums.length === 0) {
        alert('æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å·ç ï¼Œè¯·è°ƒæ•´ç­›é€‰æ¡ä»¶ï¼');
        window.unionFilteredNums = [];
        window.unionFilteredCountMap = {};
        return;
    }

    window.unionFilteredNums = filteredNums;
    window.unionFilteredCountMap = totalCountMap;

    alert('åº”ç”¨æˆåŠŸï¼');
    renderUnionAnalysisResult(); // <--- å°±åŠ åœ¨è¿™é‡Œ
}
function fillCodeResultByType(type) {
    if (type === 'four') {
        statAllUserCode('4', 'unionStatResult');
    } else if (type === 'eight') {
        statAllUserCode('8', 'unionStatResult');
    } else if (type === 'twelve') {
        statAllUserCode('12', 'unionStatResult');
    }
}
function statDiffCode(codeType, min, max, unionNums) {
    // è¯»å–æœ¬åœ°ä¿å­˜çš„è¯¦ç»†ç»Ÿè®¡
    let stat4 = JSON.parse(localStorage.getItem('nao_all_user_4_stat_detail') || '{}');
    let stat8 = JSON.parse(localStorage.getItem('nao_all_user_8_stat_detail') || '{}');
    let stat12 = JSON.parse(localStorage.getItem('nao_all_user_12_stat_detail') || '{}');

    let statMap = codeType === '4' ? stat4 : codeType === '8' ? stat8 : stat12;
    let other1 = codeType === '4' ? stat8 : codeType === '8' ? stat4 : stat4;
    let other2 = codeType === '12' ? stat8 : stat12;

    let nums = Object.keys(statMap);
    let otherNums = new Set([...Object.keys(other1), ...Object.keys(other2)]);

    // å·®é›†
    let diffNums = nums.filter(num => !otherNums.has(num));

    // è¿‡æ»¤å‡ºç°æ¬¡æ•°
    let filtered = diffNums.filter(num => {
        let cnt = statMap[num]?.length || 0;
        return cnt >= min && cnt <= max;
    });

    // è¿‡æ»¤å¹¶é›†åˆ†æç»“æœ
    if (unionNums && unionNums.length) {
        filtered = filtered.filter(num => !unionNums.includes(num));
    }

    // å±•ç¤º
    let title = codeType === '4' ? '4ç å·®é›†' : codeType === '8' ? '8ç å·®é›†' : '12ç å·®é›†';
    let html = `<div style="color:#ffd700;font-weight:bold;margin-bottom:6px;">${title}ï¼ˆå‡ºç°æ¬¡æ•°${min}~${max}ï¼Œæ’é™¤å¹¶é›†ï¼‰</div>`;
    html += filtered.length ? filtered.join(' ') : 'æ— ç¬¦åˆæ¡ä»¶å·ç ';
    document.getElementById(`diffStatResult_${codeType}`).innerHTML = html;
}

function filterUnionNums(unionNums) {
    let excludeNums = JSON.parse(localStorage.getItem('nao_diff_exclude_nums') || '[]');
    return unionNums.filter(num => !excludeNums.includes(num));
}
function statAllUserCode(codeType, containerId) {
    // è¯»å–å¤§æ•°æ®è¾“å…¥
    const input = document.getElementById('bigDataInput').value.trim();
    if (!input) {
        alert('è¯·å…ˆåœ¨å¤§æ•°æ®è§£æé¡µé¢è¾“å…¥ç”¨æˆ·æ•°æ®ï¼');
        return;
    }
    // è§£ææ‰€æœ‰ç”¨æˆ·æ•°æ®
    const users = parseUserData(input, [codeType]);
    const { sx, head, tail } = coreParam;
    let numUserMap = {};
    Object.entries(users).forEach(([userName, codeMap]) => {
        if (codeMap[codeType]) {
            let nums = Array.from(codeMap[codeType]);
            nums = nums.filter(num => {
                let inSx = sx.some(s => (shengxiaoMap[s]||[]).map(n=>String(n).padStart(2,'0')).includes(num));
                if (!inSx) return false;
                let h = parseInt(num,10) >= 10 ? num[0] : '0';
                if (!head.includes(h)) return false;
                let t = num[num.length-1];
                if (!tail.includes(t)) return false;
                return true;
            });
            let uniqueNums = Array.from(new Set(nums));
            uniqueNums.forEach(num => {
                if (!numUserMap[num]) numUserMap[num] = new Set();
                numUserMap[num].add(userName);
            });
        }
    });
    let countMap = {};
    for (let i = 1; i <= 49; i++) {
        let num = i.toString().padStart(2, '0');
        countMap[num] = numUserMap[num] ? numUserMap[num].size : 0;
    }
    let html = `<div style="color:#ffd700;font-weight:bold;margin-bottom:6px;">æ‰€æœ‰ç”¨æˆ·${codeType}ç ç»Ÿè®¡ï¼ˆæ¯ä¸ªå·ç è¢«å¤šå°‘äººä½¿ç”¨ï¼‰</div>`;
    let group = {};
    Object.keys(countMap).forEach(num => {
        let cnt = countMap[num];
        if (!group[cnt]) group[cnt] = [];
        group[cnt].push(num);
    });
    let keys = Object.keys(group).map(Number).sort((a, b) => b - a);
keys.forEach(cnt => {
    let nums = group[cnt].sort((a, b) => a - b);
    if (nums.length === 0) return;
    // æ‹¼æ¥æ‰€æœ‰ç”¨æˆ·
    let allUsers = [];
    nums.forEach(num => {
        let users = Array.from(numUserMap[num] || []);
        allUsers = allUsers.concat(users);
    });
    // å»é‡
    allUsers = Array.from(new Set(allUsers));
    let userStr = allUsers.length ? allUsers.join('ï¼Œ') : 'æ— ç”¨æˆ·';
    // æ¬¡æ•°æ ‡ç­¾å¯ç‚¹å‡»
    let cntHtml = `<span style="cursor:pointer;color:#ffd700;font-weight:bold;" onclick="alert('å‡ºç°${cnt}æ¬¡çš„æ‰€æœ‰å·ç è¢«ä»¥ä¸‹ç”¨æˆ·ä½¿ç”¨ï¼š\\n${userStr}')">${cnt}æ¬¡</span>`;
    html += `ã€–${cntHtml}ã€—${nums.join(' ')}ï¼ˆå…±${nums.length}ä¸ªï¼‰<br>`;
});
    document.getElementById(containerId).innerHTML = html;

    // è®©ä¿å­˜æŒ‰é’®æ˜¾ç¤º
    const saveBtn = document.getElementById(`saveAllUser${codeType}StatBtn`);
    if (saveBtn) {
        saveBtn.style.display = '';
        saveBtn.disabled = false;
        saveBtn.classList.add('enabled');
    }

    // ä¸´æ—¶ä¿å­˜æ˜ç»†åˆ° windowï¼Œä¾›ä¿å­˜æŒ‰é’®ç”¨
    window[`_numUserMap_${codeType}`] = numUserMap;
    window[`_statHtml_${codeType}`] = html;
}
function saveAllUserStat(codeType) {
    const numUserMap = window[`_numUserMap_${codeType}`];
    const html = window[`_statHtml_${codeType}`];
    if (!numUserMap || !html) {
        alert('è¯·å…ˆç»Ÿè®¡å†ä¿å­˜ï¼');
        return;
    }
    // Setè½¬Arrayå†ä¿å­˜
    let numUserMapObj = {};
    Object.keys(numUserMap).forEach(num => {
        numUserMapObj[num] = Array.from(numUserMap[num]);
    });
    localStorage.setItem(`nao_all_user_${codeType}_stat_result`, html);
    localStorage.setItem(`nao_all_user_${codeType}_stat_detail`, JSON.stringify(numUserMapObj));
    alert('ä¿å­˜æˆåŠŸï¼');
}
function getDiffNumsInRange(statObj, min, max) {
    // åªä¿ç•™å‡ºç°æ¬¡æ•°åœ¨[min, max]åŒºé—´å†…çš„å·ç 
    return Object.keys(statObj)
        .filter(num => {
            const cnt = statObj[num]?.length || 0;
            return cnt >= min && cnt <= max;
        })
        .map(num => num.padStart(2, '0'));
}
function applyAllDiffSetting() {
    // è¯»å–æœ¬åœ°ç»Ÿè®¡æ•°æ®
    const stat4 = localStorage.getItem('nao_all_user_4_stat_detail');
    const stat8 = localStorage.getItem('nao_all_user_8_stat_detail');
    const stat12 = localStorage.getItem('nao_all_user_12_stat_detail');

    if (!isValidStat(stat4) || !isValidStat(stat8) || !isValidStat(stat12)) {
        alert('è¯·å…ˆä¿å­˜æ‰€æœ‰ç”¨æˆ·4ç ã€8ç ã€12ç ç»Ÿè®¡ç»“æœåå†åº”ç”¨è®¾ç½®ï¼');
        return;
    }

    // è·å–å‚æ•°
    const params = {
        '4': {min: parseInt(document.getElementById('diffMin_4').value), max: parseInt(document.getElementById('diffMax_4').value)},
        '8': {min: parseInt(document.getElementById('diffMin_8').value), max: parseInt(document.getElementById('diffMax_8').value)},
        '12': {min: parseInt(document.getElementById('diffMin_12').value), max: parseInt(document.getElementById('diffMax_12').value)}
    };
    let stat4Obj = JSON.parse(stat4);
    let stat8Obj = JSON.parse(stat8);
    let stat12Obj = JSON.parse(stat12);

    // åªä¿ç•™åŒºé—´å†…çš„å·ç 
    let nums4 = getDiffNumsInRange(stat4Obj, params['4'].min, params['4'].max);
    let nums8 = getDiffNumsInRange(stat8Obj, params['8'].min, params['8'].max);
    let nums12 = getDiffNumsInRange(stat12Obj, params['12'].min, params['12'].max);

    // ä¿å­˜åˆ°æœ¬åœ°
    localStorage.setItem('nao_diff_exclude_4', JSON.stringify(nums4));
    localStorage.setItem('nao_diff_exclude_8', JSON.stringify(nums8));
    localStorage.setItem('nao_diff_exclude_12', JSON.stringify(nums12));

    // å±•ç¤ºåˆ°é¡µé¢
    document.getElementById('excludeNums_4').innerHTML = nums4.length
        ? nums4.slice().sort((a, b) => a - b).map(n => `<span style="color:red">${n}</span>`).join(' ')
        : 'æ— ';
    document.getElementById('excludeNums_8').innerHTML = nums8.length
        ? nums8.slice().sort((a, b) => a - b).map(n => `<span style="color:red">${n}</span>`).join(' ')
        : 'æ— ';
    document.getElementById('excludeNums_12').innerHTML = nums12.length
        ? nums12.slice().sort((a, b) => a - b).map(n => `<span style="color:red">${n}</span>`).join(' ')
        : 'æ— ';

    renderMergedExcludeNums();

    alert('å‚æ•°è®¾ç½®æˆåŠŸï¼Œå·²è‡ªåŠ¨ç­›é€‰å¯¹åº”å·ç ï¼');
}

/**
 * è·å–å·®é›†å·ç ï¼šå³åœ¨statObjä¸­ï¼Œå‡ºç°æ¬¡æ•°ä¸åœ¨[min, max]èŒƒå›´å†…çš„å·ç 
 * @param {string} codeType - '4' | '8' | '12'
 * @param {Object} statObj - ç»Ÿè®¡å¯¹è±¡ï¼Œæ ¼å¼å¦‚ { '01': ['ç”¨æˆ·A', 'ç”¨æˆ·B'], ... }
 * @param {number} min
 * @param {number} max
 * @returns {string[]} - éœ€è¦æ’é™¤çš„å·ç æ•°ç»„
 */
function getDiffNums(codeType, statObj, statObj2, statObj3, min, max) {
    // æ’é™¤å‡ºç°æ¬¡æ•°å°äºminæˆ–å¤§äºmaxçš„å·ç ï¼Œè¿”å›ä¸¤ä½å­—ç¬¦ä¸²
    return Object.keys(statObj)
        .filter(num => {
            const cnt = statObj[num]?.length || 0;
            return cnt < min || cnt > max;
        })
        .map(num => num.padStart(2, '0'));
}
function isValidStat(statStr) {
    if (!statStr || statStr === 'null' || statStr.trim() === '') return false;
    try {
        const obj = JSON.parse(statStr);
        // åˆ¤æ–­å¯¹è±¡æ˜¯å¦æœ‰å†…å®¹ï¼ˆæ•°ç»„æœ‰é•¿åº¦ï¼Œå¯¹è±¡æœ‰é”®ï¼‰
        if (Array.isArray(obj)) return obj.length > 0;
        if (typeof obj === 'object' && obj !== null) return Object.keys(obj).length > 0;
        return false;
    } catch (e) {
        return false;
    }
}

function applyAllDiffSetting() {
    // è¯»å–æœ¬åœ°ç»Ÿè®¡æ•°æ®
    const stat4 = localStorage.getItem('nao_all_user_4_stat_detail');
    const stat8 = localStorage.getItem('nao_all_user_8_stat_detail');
    const stat12 = localStorage.getItem('nao_all_user_12_stat_detail');

    // ä¸¥æ ¼åˆ¤æ–­å†…å®¹æ˜¯å¦æœ‰æ•ˆ
    if (!isValidStat(stat4) || !isValidStat(stat8) || !isValidStat(stat12)) {
        alert('è¯·å…ˆä¿å­˜æ‰€æœ‰ç”¨æˆ·4ç ã€8ç ã€12ç ç»Ÿè®¡ç»“æœåå†åº”ç”¨è®¾ç½®ï¼');
        return;
    }

    // è·å–å‚æ•°
    const params = {
        '4': {min: parseInt(document.getElementById('diffMin_4').value), max: parseInt(document.getElementById('diffMax_4').value)},
        '8': {min: parseInt(document.getElementById('diffMin_8').value), max: parseInt(document.getElementById('diffMax_8').value)},
        '12': {min: parseInt(document.getElementById('diffMin_12').value), max: parseInt(document.getElementById('diffMax_12').value)}
    };
    let stat4Obj = JSON.parse(stat4);
    let stat8Obj = JSON.parse(stat8);
    let stat12Obj = JSON.parse(stat12);

    // è®¡ç®—æ’é™¤å·ç 
    let exclude4 = getDiffNums('4', stat4Obj, stat8Obj, stat12Obj, params['4'].min, params['4'].max);
    let exclude8 = getDiffNums('8', stat8Obj, stat4Obj, stat12Obj, params['8'].min, params['8'].max);
    let exclude12 = getDiffNums('12', stat12Obj, stat4Obj, stat8Obj, params['12'].min, params['12'].max);

    // ä¿å­˜åˆ°æœ¬åœ°
    localStorage.setItem('nao_diff_exclude_4', JSON.stringify(exclude4));
    localStorage.setItem('nao_diff_exclude_8', JSON.stringify(exclude8));
    localStorage.setItem('nao_diff_exclude_12', JSON.stringify(exclude12));

    // å±•ç¤ºåˆ°é¡µé¢ï¼ˆæ’é™¤å·ç ç”¨çº¢è‰²æ˜¾ç¤ºï¼Œä¸”ä»å°åˆ°å¤§æ’åºï¼‰
    document.getElementById('excludeNums_4').innerHTML = exclude4.length
        ? exclude4.slice().sort((a, b) => a - b).map(n => `<span style="color:red">${n}</span>`).join(' ')
        : 'æ— ';
    document.getElementById('excludeNums_8').innerHTML = exclude8.length
        ? exclude8.slice().sort((a, b) => a - b).map(n => `<span style="color:red">${n}</span>`).join(' ')
        : 'æ— ';
    document.getElementById('excludeNums_12').innerHTML = exclude12.length
        ? exclude12.slice().sort((a, b) => a - b).map(n => `<span style="color:red">${n}</span>`).join(' ')
        : 'æ— ';

    // å…³é”®ï¼šåŠ è¿™ä¸€è¡Œ
    renderMergedExcludeNums();

    alert('å‚æ•°è®¾ç½®æˆåŠŸï¼Œå·²è‡ªåŠ¨æ’é™¤å¯¹åº”å·ç ï¼');
}

function getNumsFromHtml(html) {
    // æå–æ‰€æœ‰ä¸¤ä½æ•°å­—ï¼ˆå…¼å®¹æœ‰<span>æ ‡ç­¾çš„æƒ…å†µï¼‰
    return (html.match(/\d{2}/g) || []);
}

// åªä¿ç•™åœ¨ä¸‰ç»„ä¸­è‡³å°‘å‡ºç°2æ¬¡çš„æ•°å­—
function getMergedExcludeNums() {
    const el4 = document.getElementById('excludeNums_4');
    const el8 = document.getElementById('excludeNums_8');
    const el12 = document.getElementById('excludeNums_12');
    if (!el4 || !el8 || !el12) return [];
    const arr4 = getNumsFromHtml(el4.innerHTML);
    const arr8 = getNumsFromHtml(el8.innerHTML);
    const arr12 = getNumsFromHtml(el12.innerHTML);
    const countMap = {};
    [arr4, arr8, arr12].forEach(arr => {
        arr.forEach(num => {
            countMap[num] = (countMap[num] || 0) + 1;
        });
    });
    return Object.keys(countMap).filter(num => countMap[num] >= 2).sort((a, b) => a - b);
}

function renderMergedExcludeNums() {
    const merged = getMergedExcludeNums();
    document.getElementById('diffExcludeSummary').innerHTML = `
        <div style="font-size:16px;font-weight:bold;margin-bottom:8px;">
            åˆå¹¶å»é‡æ’é™¤æ•°å­—ï¼ˆä»…ä¿ç•™åœ¨ä¸‰ç»„ä¸­è‡³å°‘å‡ºç°2æ¬¡çš„æ•°å­—ï¼Œå…± <span style="color:#ff4c4c;">${merged.length}</span> ä¸ªï¼‰ï¼š
        </div>
        <div style="font-size:13px;color:#fff;">${merged.length ? merged.join(' ') : 'æ— '}</div>
        <button id="saveMergedExcludeBtn"
            style="margin-top:8px;padding:2px 8px;font-size:12px;height:24px;background:#00e676;color:#232526;border:none;border-radius:4px;cursor:pointer;">
            ä¿å­˜åˆå¹¶æ’é™¤æ•°å­—åˆ°æœ¬åœ°
        </button>
    `;
    document.getElementById('saveMergedExcludeBtn').onclick = function() {
        localStorage.setItem('nao_merged_exclude_nums', JSON.stringify(merged));
        alert('ä¿å­˜æˆåŠŸï¼');
    };
}

// ====== å…³é”®ï¼šå¹¶é›†åˆ†ææ—¶åªæ’é™¤æœ¬åœ°å·²ä¿å­˜çš„åˆå¹¶å»é‡æ’é™¤æ•°å­— ======
function getMergedExcludeNumsFromLocal() {
    try {
        return JSON.parse(localStorage.getItem('nao_merged_exclude_nums') || '[]');
    } catch (e) {
        return [];
    }
}

function getFilteredUnionNums() {
    // åªç”¨æœ¬åœ°ä¿å­˜çš„åˆå¹¶å»é‡æ’é™¤æ•°å­—åšæ’é™¤
    const excludeNums = new Set(getMergedExcludeNumsFromLocal());
    const allNums = [];
    for (let i = 1; i <= 49; i++) {
        let num = i.toString().padStart(2, '0');
        if (!excludeNums.has(num)) allNums.push(num);
    }
    return allNums;
}

function renderUnionAnalysisResult() {
    const filteredNums = window.unionFilteredNums || [];
    const countMap = window.unionFilteredCountMap || {};

    const numScores = filteredNums.map(num => ({
        num,
        score: countMap[num] || 0
    }));

    if (numScores.length === 0) {
        document.getElementById('unionStatResult').innerHTML = '<div style="color:#ff4c4c;">æ— æ•°æ®</div>';
        return;
    }

    const scores = numScores.map(x => x.score).sort((a, b) => a - b);
    const minScore = scores[0];
    const maxScore = scores[scores.length - 1];
    const midIdx = Math.floor(scores.length / 2);
    const median = scores.length % 2 === 0
        ? (scores[midIdx - 1] + scores[midIdx]) / 2
        : scores[midIdx];

    const midHigh = numScores.filter(x => x.score > median && x.score < maxScore).sort((a, b) => b.score - a.score);
    const midLow = numScores.filter(x => x.score < median && x.score > minScore).sort((a, b) => b.score - a.score);
    const highest = numScores.filter(x => x.score === maxScore);
    const lowest = numScores.filter(x => x.score === minScore);

    const finalOrder = [...midHigh, ...midLow, ...highest, ...lowest];

    document.getElementById('unionStatResult').innerHTML = `
        <div style="font-size:16px;font-weight:bold;margin-bottom:8px;">
            å¹¶é›†åˆ†æç»“æœï¼ˆä¸­é«˜â†’ä¸­ä¸‹â†’æœ€é«˜â†’æœ€ä½ï¼Œæ€»æ¬¡æ•°æ’åºï¼Œå‰©ä½™ <span style="color:#00e676;">${filteredNums.length}</span> ä¸ªï¼‰ï¼š
        </div>
        <div style="font-size:13px;color:#fff;">
            ${finalOrder.map(x => `<span>${x.num}(${x.score})</span>`).join(' ')}
        </div>
    `;
}
 
</script>
</body>
</html>
